(function(){"use strict";function y(d,a){if(a<0)return-y(-d,-a);let e=(d%a+a)%a;return e<0&&(e+=a),e}function K(d,a){return a===0?d:K(a,d%a)}function X(d,a){return d*a/K(d,a)}class Y{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.offset=i}}class A{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.span=i}element(a){let e=this.data.length,i=0;return a>=0?i=this.data[y(a,e)]+Math.abs(this.span)*~~(a/e):i=this.data[y(a,e)]+Math.abs(this.span)*(~~((a+1)/e)-1),i}rototranslate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new A(s,this.modulo,this.span)}spanUpdate(){let a=this.data[0],e=this.data[0],i=this.modulo;for(let n=0;n<this.data.length;n++)this.data[n]>a&&(a=this.data[n]),this.data[n]<e&&(e=this.data[n]);let s=a-e;if(i<=s)for(;i<=s;)i+=this.modulo;this.span=i}invert(a=!0){let e=this.data.slice();for(let i=0;i<e.length;i++)e[i]*=-1;return a&&(this.data=e),new A(e,this.modulo,this.span)}negative(a=10,e=!0,i=!0){let s=this.data.slice(),n=a;if(e){for(let l=0;l<s.length;l++)s[l]*=2;n=a*2-1}for(let l=0;l<s.length;l++)s[l]-=n;for(let l=0;l<s.length;l++)s[l]*=-1;for(let l=0;l<s.length;l++)s[l]+=n;if(e)for(let l=0;l<s.length;l++)s[l]/=2;s.sort(function(l,r){return l-r});let o=new A(s,this.modulo,this.span);return o.rototranslate(-1),i&&(this.data=s),o}options(a){let e=[],i=this.data.length;for(let s=a-i;s<a+i;s++){const n=this.rototranslate(s,i,!1);e.push(n)}return e}selectFromPosition(a){let e=[];for(let s=0;s<a.data.length;s++)e.push(this.element(a.data[s]));let i=new A(e,this.modulo,this.span);return i.spanUpdate(),i}freeInvert(a=1){if(this.data.length===0)return this;let e=new Array(this.data.length);switch(a){case 0:{const i=this.data[0];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 2:{const i=this.data[this.data.length-1];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 1:default:e=this.data.slice().reverse();break}return new A(e,this.modulo,this.span)}sum(a=0){let e=[...this.data];for(let i=0;i<this.data.length;i++)e[i]+=a;return new A(e,this.modulo,this.span)}toZero(a=!1){let e=new A(this.data.slice(),this.modulo,this.span),i=e.data[0];for(let s=0;s<e.data.length;s++)e.data[s]=y(e.data[s]-i,e.modulo);return e.data.sort((s,n)=>s-n),e.spanUpdate(),a&&(this.data=e.data,this.span=e.span,this.modulo=e.modulo),e}isNote(a){for(let e=0;e<this.data.length;e++)if(y(this.data[e],this.modulo)===y(a,this.modulo))return!0;return!1}isAvoid(a){if(this.isNote(a))return!1;const e=this.modulo/2;for(let i=1;i<this.data.length;i++){const s=y(this.data[i],this.modulo);if(y(a-s,this.modulo)===e)return!0}return!1}degreeFunction(){let a=this.sum(-this.data[0]).normalizeToModulo(),e=a.data,i=a.toBinary().data,s=Array.from({length:this.data.length},(t,h)=>h);for(let t=1;t<e.length;t++)e[t]=y(Math.round(e[t]*12/this.modulo),12);let n=new Array(this.data.length);n[0]=0;let o=new Set,l=new Set;l.add(0);for(const t of s.slice())e[t]==0&&(n[t]=0,o.add("f"),s.splice(s.indexOf(t),1)),e[t]==4&&(n[t]=2,l.add(4),o.add("3maj"),s.splice(s.indexOf(t),1)),e[t]==7&&(n[t]=4,l.add(7),o.add("5"),s.splice(s.indexOf(t),1)),e[t]==11&&(n[t]=6,l.add(11),o.add("7maj"),s.splice(s.indexOf(t),1));if(!o.has("3maj")&&i[3]==!0){for(const t of s)if(e[t]==3){n[t]=2,l.add(3),o.add("3min"),s.splice(s.indexOf(t),1);break}}if(!o.has("5")&&!o.has("3min")&&i[8]==!0){for(const t of s)if(e[t]==8){n[t]=4,l.add(8),o.add("5aug"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&i[2]==!0){for(const t of s)if(e[t]==2){n[t]=2,l.add(2),o.add("3dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&i[5]==!0){for(const t of s)if(e[t]==5){n[t]=2,l.add(5),o.add("3aug"),s.splice(s.indexOf(t),1);break}}const r=i[10]==!0;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||r)&&i[6]==!0){for(const t of s)if(e[t]==6){n[t]=4,l.add(6),o.add("5dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&i[10]==!0){for(const t of s)if(e[t]==10){n[t]=6,l.add(10),o.add("7min"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&!o.has("7min")&&i[9]==!0){for(const t of s)if(e[t]==9){n[t]=6,l.add(9),o.add("7dim"),s.splice(s.indexOf(t),1);break}}for(const t of s)e[t]<4?(n[t]=1,e[t]==1?o.add("2min"):e[t]==2?o.add("2"):e[t]==3&&o.add("2aug")):e[t]>4&&e[t]<7?(n[t]=3,e[t]==5?o.add("4"):e[t]==6&&o.add("4aug")):e[t]>7&&e[t]<11&&(n[t]=5,e[t]==8?o.add("6min"):e[t]==9?o.add("6"):e[t]==10&&o.add("6aug"));return{degreeFunction:this.data.map((t,h)=>({degree:n[h]})),intervalTypes:o,baseChord:l}}isExtension(a){const{baseChord:e}=this.degreeFunction(),i=Math.round(y(a-this.data[0],this.modulo)*12/this.modulo);return!e.has(i)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((e,i)=>{const s=parseInt(e,10),n=parseInt(i,10);return s-n})}getDegrees(){return this.degreeFunction().degreeFunction.map(a=>a.degree)}normalizeToModulo(){const a=this.data.map(n=>y(n,this.modulo)),e=a[0],s=a.map(n=>n<e?n+this.modulo:n).sort((n,o)=>n-o);return new A(s,this.modulo,this.span)}toBinary(){let a=new Y(new Array(this.span).fill(!1),this.modulo,this.data[0]),e=this.sum(-this.data[0]);for(const i of e.data){let s=y(i,this.span);a.data[s]=!0}return a}}function q(d,a){if(d.modulo===a.modulo)return[d,a];let e=X(d.modulo,a.modulo),i=[];for(let n=0;n<d.data.length;n++)i.push(e/d.modulo*d.data[n]);let s=[];for(let n=0;n<a.data.length;n++)s.push(e/a.modulo*a.data[n]);return[new A(i,e,e/d.modulo*d.span),new A(s,e,e/a.modulo*a.span)]}function H(d,a){a.spanUpdate();let e=new A([],a.data.length,a.data.length),i=Math.floor(d.data[0]/d.modulo);if(a.element(i)>d.data[0])for(;a.element(i)>d.data[0];)i--;else if(a.element(i)<d.data[0]){for(;a.element(i)<d.data[0];)i++;i--}for(let s=0;s<d.data.length;s++){for(;a.element(i)<d.data[s];)i++;if(a.element(i)==d.data[s])e.data.push(i);else throw new Error("Error: Impossible finding element: "+d.data[s]+" nella scale."+a.data)}return e}class k{constructor(a,e=12,i=0){this.data=a,this.modulo=e,this.offset=i}element(a){return this.data[y(a,this.data.length)]}rotate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new k(s,this.modulo,this.offset)}invert(a=!0){let e=this.data.length,i=new Array(e);for(let s=0;s<e;s++)i[s]=this.data[e-1-s];return a&&(this.data=i),new k(i,this.modulo,this.offset)}singleMirror(a,e,i=!0){let s=this.data,n=s.length;if(a=y(a,n),e)for(let o=0;o<a/2;++o){let l=s[o];s[o]=s[a-1-o],s[a-1-o]=l}else{let o=a+(n-a)/2;for(let l=a;l<o;++l){let r=s[l];s[l]=s[n-1-(l-a)],s[n-1-(l-a)]=r}}return i&&(this.data=s),new k(s,this.modulo,this.offset)}}const V={intervals:new k([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function _({intervals:d=new k([2,2,1,2,2,2,1],12,0),root:a=0,modo:e=0,grado:i=0,isInvert:s=!1,isMirror:n=!1,mirrorPos:o=0,mirrorLeft:l=!1}=V){d.offset=a;let r=d.rotate(e);s&&(r=r.invert()),n&&(r=r.singleMirror(o,l));let c=ee(r);return c.spanUpdate(),c.rototranslate(i),c}function ee(d){let a=d.data.length,e=new Array(a),i=d.offset;for(let s=0;s<a;s++)e[s]=i,i+=d.data[s];return i-=d.offset,new A(e,d.modulo,i)}_();function te(d,a=!1){let e=d;e=e.sum(-d.data[0]);for(let r=1;r<e.data.length;r++)e.data[r]=y(e.data[r],e.modulo);e.data.sort((r,c)=>r-c),e.data=[...new Set(e.data)],e=e.sum(+d.data[0]);let i=[],s=1;a&&(s=e.data.length);const n=(r,c,t)=>{let h=0;return h+=r.length,c!==""&&(h+=2),(r.includes("b9")||r.includes("#9")||r.includes("b13"))&&(h+=2),t.includes("+")&&(h+=2),r.includes("omit3")&&(h+=3),r.includes("omit5")&&(h+=2),(r.includes("add9")||r.includes("addb9")||r.includes("add#9")||r.includes("add11")||r.includes("add#11")||r.includes("add13")||r.includes("addb13")||r.includes("add#13"))&&(h+=3),r.includes("#13")&&(h+=7),(r.includes("sus2")||r.includes("sus4"))&&(h+=2),h};for(let r=0;r<s;r++){let c=e.rototranslate(r,e.data.length,!1),t=new Set(c.getIntervalTypes()),h="",f=[],v="";t.has("5aug")&&(h="+"),t.has("3min")?t.has("5dim")?h="dim":h="-":!t.has("3maj")&&!t.has("3min")&&t.has("3dim")&&t.has("3aug")&&(h="5"),t.has("7maj")?t.has("2")?h+="maj9":h+="maj7":t.has("7min")?(h=="dim"&&(h="Ã¸"),t.has("2")?h+="9":h+="7"):t.has("7dim")&&(h!="dim"?h+="6":h+="7"),t.has("4")&&t.has("3dim")?f.push("sus2/4"):t.has("3aug")?f.push("sus4"):t.has("3dim")&&f.push("sus2"),t.has("5dim")&&!t.has("5")&&!t.has("5aug")&&!h.startsWith("dim")&&!h.startsWith("Ã¸")&&f.push("b5"),t.has("2min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb9"):f.push("b9")),t.has("2")&&(h.includes("9")||(!t.has("7maj")&&!t.has("7min")?f.push("add9"):f.push("9"))),t.has("2aug")&&(!t.has("7maj")&&!t.has("7min")?f.push("add#9"):f.push("#9")),t.has("4")&&!t.has("3dim")&&(!t.has("7maj")&&!t.has("7min")||t.has("3maj")?f.push("add11"):f.push("11")),t.has("4aug")&&!f.includes("b5")&&(!t.has("7maj")&&!t.has("7min")&&!t.has("7dim")?f.push("add#11"):f.push("#11")),t.has("6min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb13"):f.push("b13")),t.has("6")&&(!t.has("7maj")&&!t.has("7min")?f.push("add13"):f.push("13")),t.has("6aug")&&f.push("#13"),!t.has("3maj")&&!t.has("3min")&&!t.has("3aug")&&!t.has("3dim")&&f.push("omit3"),!t.has("5")&&!t.has("5dim")&&!t.has("5aug")&&f.push("omit5");const N=new A([c.data[0]],d.modulo,d.span);if(a&&r!==0){const B=y(e.data.length-r,e.data.length);v=`/${G(c,!1,!1,!0)[B]}`}let m="Indefinito";t.has("3maj")?m="Maggiore":t.has("3min")?m="Minore":t.has("3dim")||t.has("2")?m="Sus 2":(t.has("3aug")||t.has("4"))&&(m="Sus 4");let g="Omessa";t.has("5")?g="Giusta":t.has("5aug")?g="Aumentata":t.has("5dim")&&(g="Diminuita");let I="Triade";t.has("7maj")?I="Mag 7":t.has("7min")?I="Min 7":(t.has("7dim")||t.has("6"))&&(I="Sesta/Dim");const x=[];t.has("2min")&&x.push("b9"),t.has("2")&&!m.includes("Sus")&&x.push("9"),t.has("2aug")&&x.push("#9"),t.has("4")&&!m.includes("Sus")&&x.push("11"),t.has("4aug")&&x.push("#11"),t.has("6min")&&x.push("b13"),t.has("6")&&!I.includes("Sesta")&&x.push("13"),t.has("6aug")&&x.push("#13");const w={thirdQuality:m,fifthQuality:g,seventhQuality:I,extensions:x},j=G(c,!1,!1,!1)[0],T=n(f,v,h);i.push([N,h,f,v,Array.from(t),w,j,T])}i.sort((r,c)=>{const t=r[7],h=c[7];return t-h});let o=0;o=0;const l=i[o];return{root:l[0],base:l[1],quality:l[2],inversion:l[3],intervals:l[4],detailedAnalysis:l[5],rootName:l[6],options:i}}function J(d,a=!1){const e=te(d,a),i=e.rootName,s=`${i}${e.base}${Array.isArray(e.quality)&&e.quality.length>0?e.quality.join(""):""}${e.inversion}`,n=e.options.map(o=>{const l=o[6],r=o[1],c=Array.isArray(o[2])?o[2]:[],t=c.length>0?c.join(""):"",h=o[3]||"";return{chordName:`${l}${r}${t}${h}`,root:o[0].normalizeToModulo(),components:{rootName:l,base:r,quality:c,inversion:h,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}});return{chordName:s,root:e.root.normalizeToModulo(),rootName:i,base:e.base,quality:e.quality,inversion:e.inversion,intervals:e.intervals,detailedAnalysis:e.detailedAnalysis,options:n}}function G(d,a=!0,e=!1,i=!0,s=!1){const l=a?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],r=new A([0,2,4,5,7,9,11],12,12),c=new k([2,2,1,2,2,2,1],12,0);let t=q(r,d),h=t[0],f=t[1],v=Math.floor(f.data[0]/f.modulo)*f.modulo;const N=f.sum(-v);let m=0,g=N,I=0;if(s&&(I=H(J(g,!0).root,g).data[0],g=g.rototranslate(I)),h.element(m)<g.data[0])for(;h.element(m)<g.data[0];)m++;else for(;h.element(m)>=g.data[0];)m--;const x=g.degreeFunction();let w=x.degreeFunction.map(u=>u.degree);const j=x.intervalTypes,T=w.indexOf(6);T!==-1&&j.has("7dim")&&(w[T]=5);const B=w.indexOf(2);B!==-1&&j.has("3dim")&&(w[B]=1);const S=w.indexOf(2);S!==-1&&j.has("3aug")&&(w[S]=3);const P=w.indexOf(3);P!==-1&&(j.has("5dim")||j.has("4aug"))&&j.has("7min")&&(w[P]=4);let R=[],U=w,F=1/0,Q=m,z=1/0;for(let u=-1;u<=1;u++){let D=[],O=0,C=m+u;for(let E=0;E<g.data.length;E++){const ae=Math.floor((g.data[E]-g.data[0])/g.modulo)*7,Z=g.data[E]-h.element(w[E]+C+ae);D[E]=Z,[0,2,4].includes(w[E])?O+=2*Z:[6].includes(w[E])&&(O+=Z)}const $=Math.abs(D[0]),L=$<z,se=$===z&&Math.abs(O)<Math.abs(F);(L||se)&&(F=O,R=D,Q=C,z=$)}let p=R,M=U;if(m=Q,i)for(let u=0;u<p.length;u++){const D=c.element(M[u]+m),O=c.element(M[u]+m-1);Math.abs(p[u])>=D&&Math.sign(p[u])==1?(p[u]-=c.element(M[u]+m),M[u]+=1):Math.abs(p[u])>=O&&Math.sign(p[u])==-1&&(p[u]+=c.element(M[u]+m-1),M[u]-=1)}let b=[];for(let u=0;u<M.length;u++){const D=y(u-I,p.length),O=p[D],C=l[y(M[D]+m,7)];if(e){const $=Math.round(O*50);$!==0?b[u]=`${C} ${$>0?"â†‘":"â†“"}${Math.abs($)}Â¢`:b[u]=C}else{const $=Math.round(O);if(Math.abs(O)<1&&O!==0)b[u]=C+(O>0?"ð„²":"ð„³");else if($!==0){const L=$>0?"â™¯":"â™­";b[u]=C+L.repeat(Math.min(Math.abs($),2))}else b[u]=C}}return b}const W=new Map;self.onmessage=d=>{const{activeNotes:a,selectedIndex:e,bassAsRoot:i,useEnharmonic:s,requestId:n}=d.data,o=`${a.join(",")}|${e}|${i}|${s}`;if(W.has(o)){self.postMessage({...W.get(o),requestId:n});return}const l=new Set(a);if(l.size===0){self.postMessage({requestId:n,chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const r=Array.from(l).sort((v,N)=>v-N),c=new A(r,12,12).normalizeToModulo();let t=[];try{t=G(c,!0,!1,s,!1)}catch(v){console.error(v)}const h=new Map;r.forEach((v,N)=>{t[N]&&h.set(v,t[N])});let f=[];try{f=J(c,!i).options}catch(v){console.error(v)}if(f.length>0&&f[e]){const v=f[e],{root:N,components:m,detailedAnalysis:g}=v,I=H(N,c).data[0],x=c.rototranslate(I,c.data.length,!1),w=G(x,!0,!1,s,!1),j=(p,M)=>(p%M+M)%M;for(let p=0;p<w.length;p++){const M=j(x.data[p],12);r.forEach(b=>{j(b,12)===M&&w[p]&&h.set(b,w[p])})}const T=new Map,B=N.data[0],S=(p,M)=>{r.forEach(b=>{const u=j(b,12),D=j(u-B,12);p.includes(D)&&T.set(b,M)})};r.forEach(p=>T.set(p,"ext")),S([0],"root");const{thirdQuality:P,fifthQuality:R,seventhQuality:U}=g;P==="Maggiore"?S([4],"third"):P==="Minore"?S([3],"third"):P==="Sus 2"?S([2],"third"):P==="Sus 4"&&S([5],"third"),R==="Giusta"?S([7],"fifth"):R==="Aumentata"?S([8],"fifth"):R==="Diminuita"&&S([6],"fifth"),U==="Mag 7"?S([11],"seventh"):U==="Min 7"?S([10],"seventh"):U==="Sesta/Dim"&&S([9],"seventh");const F=(p,M)=>{r.forEach(b=>{const u=j(b,12),D=j(u-B,12);p.includes(D)&&T.get(b)==="ext"&&T.set(b,M)})};F([1],"b9"),F([2],"9"),F([3],"#9"),F([5],"11"),F([6],"#11"),F([8],"b13"),F([9],"13"),F([10],"#13");const Q=Array.from(T.values()),z={chordOptions:f,analysis:{rootName:m.rootName,quality:g.thirdQuality,stability:g.fifthQuality,function:g.seventhQuality,extensions:g.extensions,intervals:Array.from(T),noteNames:Array.from(h),flags:{isRootActive:Q.includes("root"),isThirdActive:Q.includes("third"),isFifthActive:Q.includes("fifth"),isSeventhActive:Q.includes("seventh")}}};W.set(o,z),self.postMessage({...z,requestId:n})}else{const v=new Map;r.forEach(m=>v.set(m,"active"));const N={chordOptions:f,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:Array.from(v),noteNames:Array.from(h),flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}};W.set(o,N),self.postMessage({...N,requestId:n})}}})();
