(function(){"use strict";function v(d,a){if(a<0)return-v(-d,-a);let e=(d%a+a)%a;return e<0&&(e+=a),e}function K(d,a){return a===0?d:K(a,d%a)}function X(d,a){return d*a/K(d,a)}class Y{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.offset=i}}class A{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.span=i}element(a){let e=this.data.length,i=0;return a>=0?i=this.data[v(a,e)]+Math.abs(this.span)*~~(a/e):i=this.data[v(a,e)]+Math.abs(this.span)*(~~((a+1)/e)-1),i}rototranslate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new A(s,this.modulo,this.span)}spanUpdate(){let a=this.data[0],e=this.data[0],i=this.modulo;for(let n=0;n<this.data.length;n++)this.data[n]>a&&(a=this.data[n]),this.data[n]<e&&(e=this.data[n]);let s=a-e;if(i<=s)for(;i<=s;)i+=this.modulo;this.span=i}invert(a=!0){let e=this.data.slice();for(let i=0;i<e.length;i++)e[i]*=-1;return a&&(this.data=e),new A(e,this.modulo,this.span)}negative(a=10,e=!0,i=!0){let s=this.data.slice(),n=a;if(e){for(let l=0;l<s.length;l++)s[l]*=2;n=a*2-1}for(let l=0;l<s.length;l++)s[l]-=n;for(let l=0;l<s.length;l++)s[l]*=-1;for(let l=0;l<s.length;l++)s[l]+=n;if(e)for(let l=0;l<s.length;l++)s[l]/=2;s.sort(function(l,r){return l-r});let o=new A(s,this.modulo,this.span);return o.rototranslate(-1),i&&(this.data=s),o}options(a){let e=[],i=this.data.length;for(let s=a-i;s<a+i;s++){const n=this.rototranslate(s,i,!1);e.push(n)}return e}selectFromPosition(a){let e=[];for(let s=0;s<a.data.length;s++)e.push(this.element(a.data[s]));let i=new A(e,this.modulo,this.span);return i.spanUpdate(),i}freeInvert(a=1){if(this.data.length===0)return this;let e=new Array(this.data.length);switch(a){case 0:{const i=this.data[0];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 2:{const i=this.data[this.data.length-1];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 1:default:e=this.data.slice().reverse();break}return new A(e,this.modulo,this.span)}sum(a=0){let e=[...this.data];for(let i=0;i<this.data.length;i++)e[i]+=a;return new A(e,this.modulo,this.span)}toZero(a=!1){let e=new A(this.data.slice(),this.modulo,this.span),i=e.data[0];for(let s=0;s<e.data.length;s++)e.data[s]=v(e.data[s]-i,e.modulo);return e.data.sort((s,n)=>s-n),e.spanUpdate(),a&&(this.data=e.data,this.span=e.span,this.modulo=e.modulo),e}isNote(a){for(let e=0;e<this.data.length;e++)if(v(this.data[e],this.modulo)===v(a,this.modulo))return!0;return!1}isAvoid(a){if(this.isNote(a))return!1;const e=this.modulo/2;for(let i=1;i<this.data.length;i++){const s=v(this.data[i],this.modulo);if(v(a-s,this.modulo)===e)return!0}return!1}degreeFunction(){let a=this.sum(-this.data[0]).normalizeToModulo(),e=a.data,i=a.toBinary().data,s=Array.from({length:this.data.length},(t,h)=>h);for(let t=1;t<e.length;t++)e[t]=v(Math.round(e[t]*12/this.modulo),12);let n=new Array(this.data.length);n[0]=0;let o=new Set,l=new Set;l.add(0);for(const t of s.slice())e[t]==0&&(n[t]=0,o.add("f"),s.splice(s.indexOf(t),1)),e[t]==4&&(n[t]=2,l.add(4),o.add("3maj"),s.splice(s.indexOf(t),1)),e[t]==7&&(n[t]=4,l.add(7),o.add("5"),s.splice(s.indexOf(t),1)),e[t]==11&&(n[t]=6,l.add(11),o.add("7maj"),s.splice(s.indexOf(t),1));if(!o.has("3maj")&&i[3]==!0){for(const t of s)if(e[t]==3){n[t]=2,l.add(3),o.add("3min"),s.splice(s.indexOf(t),1);break}}if(!o.has("5")&&!o.has("3min")&&i[8]==!0){for(const t of s)if(e[t]==8){n[t]=4,l.add(8),o.add("5aug"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&i[2]==!0){for(const t of s)if(e[t]==2){n[t]=2,l.add(2),o.add("3dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&i[5]==!0){for(const t of s)if(e[t]==5){n[t]=2,l.add(5),o.add("3aug"),s.splice(s.indexOf(t),1);break}}const r=i[10]==!0;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||r)&&i[6]==!0){for(const t of s)if(e[t]==6){n[t]=4,l.add(6),o.add("5dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&i[10]==!0){for(const t of s)if(e[t]==10){n[t]=6,l.add(10),o.add("7min"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&!o.has("7min")&&i[9]==!0){for(const t of s)if(e[t]==9){n[t]=6,l.add(9),o.add("7dim"),s.splice(s.indexOf(t),1);break}}for(const t of s)e[t]<4?(n[t]=1,e[t]==1?o.add("2min"):e[t]==2?o.add("2"):e[t]==3&&o.add("2aug")):e[t]>4&&e[t]<7?(n[t]=3,e[t]==5?o.add("4"):e[t]==6&&o.add("4aug")):e[t]>7&&e[t]<11&&(n[t]=5,e[t]==8?o.add("6min"):e[t]==9?o.add("6"):e[t]==10&&o.add("6aug"));return{degreeFunction:this.data.map((t,h)=>({degree:n[h]})),intervalTypes:o,baseChord:l}}isExtension(a){const{baseChord:e}=this.degreeFunction(),i=Math.round(v(a-this.data[0],this.modulo)*12/this.modulo);return!e.has(i)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((e,i)=>{const s=parseInt(e,10),n=parseInt(i,10);return s-n})}getDegrees(){return this.degreeFunction().degreeFunction.map(a=>a.degree)}normalizeToModulo(){const a=this.data.map(n=>v(n,this.modulo)),e=a[0],s=a.map(n=>n<e?n+this.modulo:n).sort((n,o)=>n-o);return new A(s,this.modulo,this.span)}toBinary(){let a=new Y(new Array(this.span).fill(!1),this.modulo,this.data[0]),e=this.sum(-this.data[0]);for(const i of e.data){let s=v(i,this.span);a.data[s]=!0}return a}}function q(d,a){if(d.modulo===a.modulo)return[d,a];let e=X(d.modulo,a.modulo),i=[];for(let n=0;n<d.data.length;n++)i.push(e/d.modulo*d.data[n]);let s=[];for(let n=0;n<a.data.length;n++)s.push(e/a.modulo*a.data[n]);return[new A(i,e,e/d.modulo*d.span),new A(s,e,e/a.modulo*a.span)]}function H(d,a){a.spanUpdate();let e=new A([],a.data.length,a.data.length),i=Math.floor(d.data[0]/d.modulo);if(a.element(i)>d.data[0])for(;a.element(i)>d.data[0];)i--;else if(a.element(i)<d.data[0]){for(;a.element(i)<d.data[0];)i++;i--}for(let s=0;s<d.data.length;s++){for(;a.element(i)<d.data[s];)i++;if(a.element(i)==d.data[s])e.data.push(i);else throw new Error("Error: Impossible finding element: "+d.data[s]+" nella scale."+a.data)}return e}class B{constructor(a,e=12,i=0){this.data=a,this.modulo=e,this.offset=i}element(a){return this.data[v(a,this.data.length)]}rotate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new B(s,this.modulo,this.offset)}invert(a=!0){let e=this.data.length,i=new Array(e);for(let s=0;s<e;s++)i[s]=this.data[e-1-s];return a&&(this.data=i),new B(i,this.modulo,this.offset)}singleMirror(a,e,i=!0){let s=this.data,n=s.length;if(a=v(a,n),e)for(let o=0;o<a/2;++o){let l=s[o];s[o]=s[a-1-o],s[a-1-o]=l}else{let o=a+(n-a)/2;for(let l=a;l<o;++l){let r=s[l];s[l]=s[n-1-(l-a)],s[n-1-(l-a)]=r}}return i&&(this.data=s),new B(s,this.modulo,this.offset)}}const V={intervals:new B([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function _({intervals:d=new B([2,2,1,2,2,2,1],12,0),root:a=0,modo:e=0,grado:i=0,isInvert:s=!1,isMirror:n=!1,mirrorPos:o=0,mirrorLeft:l=!1}=V){d.offset=a;let r=d.rotate(e);s&&(r=r.invert()),n&&(r=r.singleMirror(o,l));let m=ee(r);return m.spanUpdate(),m.rototranslate(i),m}function ee(d){let a=d.data.length,e=new Array(a),i=d.offset;for(let s=0;s<a;s++)e[s]=i,i+=d.data[s];return i-=d.offset,new A(e,d.modulo,i)}_();function te(d,a=!1){let e=d;e=e.sum(-d.data[0]);for(let r=1;r<e.data.length;r++)e.data[r]=v(e.data[r],e.modulo);e.data.sort((r,m)=>r-m),e.data=[...new Set(e.data)],e=e.sum(+d.data[0]);let i=[],s=1;a&&(s=e.data.length);const n=(r,m,t)=>{let h=0;return h+=r.length,m!==""&&(h+=2),(r.includes("b9")||r.includes("#9")||r.includes("b13"))&&(h+=2),t.includes("+")&&(h+=2),r.includes("omit3")&&(h+=3),r.includes("omit5")&&(h+=2),(r.includes("add9")||r.includes("addb9")||r.includes("add#9")||r.includes("add11")||r.includes("add13")||r.includes("addb13")||r.includes("add#13"))&&(h+=3),(r.includes("sus2")||r.includes("sus4"))&&(h+=2),h};for(let r=0;r<s;r++){let m=e.rototranslate(r,e.data.length,!1),t=new Set(m.getIntervalTypes()),h="",f=[],y="";t.has("5aug")&&(h="+"),t.has("3min")?t.has("5dim")?h="dim":h="-":!t.has("3maj")&&!t.has("3min")&&t.has("3dim")&&t.has("3aug")&&(h="5"),t.has("7maj")?t.has("2")?h+="maj9":h+="maj7":t.has("7min")?(h=="dim"&&(h="Ã¸"),t.has("2")?h+="9":h+="7"):t.has("7dim")&&(h!="dim"?h+="6":h+="7"),t.has("4")&&t.has("3dim")?f.push("sus2/4"):t.has("3aug")?f.push("sus4"):t.has("3dim")&&f.push("sus2"),t.has("5dim")&&!t.has("5")&&!t.has("5aug")&&!h.startsWith("dim")&&!h.startsWith("Ã¸")&&f.push("b5"),t.has("2min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb9"):f.push("b9")),t.has("2")&&(h.includes("9")||(!t.has("7maj")&&!t.has("7min")?f.push("add9"):f.push("9"))),t.has("2aug")&&(!t.has("7maj")&&!t.has("7min")?f.push("add#9"):f.push("#9")),t.has("4")&&!t.has("3dim")&&(!t.has("7maj")&&!t.has("7min")||t.has("3maj")?f.push("add11"):f.push("11")),t.has("4aug")&&!f.includes("b5")&&(!t.has("7maj")&&!t.has("7min")&&!t.has("7dim")?f.push("add#11"):f.push("#11")),t.has("6min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb13"):f.push("b13")),t.has("6")&&(!t.has("7maj")&&!t.has("7min")?f.push("add13"):f.push("13")),t.has("6aug")&&f.push("#13"),!t.has("3maj")&&!t.has("3min")&&!t.has("3aug")&&!t.has("3dim")&&f.push("omit3"),!t.has("5")&&!t.has("5dim")&&!t.has("5aug")&&f.push("omit5");const j=new A([m.data[0]],d.modulo,d.span);if(a&&r!==0){const P=v(e.data.length-r,e.data.length);y=`/${G(m,!1,!1,!0)[P]}`}let c="Indefinito";t.has("3maj")?c="Maggiore":t.has("3min")?c="Minore":t.has("3dim")||t.has("2")?c="Sus 2":(t.has("3aug")||t.has("4"))&&(c="Sus 4");let g="Omessa";t.has("5")?g="Giusta":t.has("5aug")?g="Aumentata":t.has("5dim")&&(g="Diminuita");let D="Triade";t.has("7maj")?D="Mag 7":t.has("7min")?D="Min 7":(t.has("7dim")||t.has("6"))&&(D="Sesta/Dim");const b=[];t.has("2min")&&b.push("b9"),t.has("2")&&!c.includes("Sus")&&b.push("9"),t.has("2aug")&&b.push("#9"),t.has("4")&&!c.includes("Sus")&&b.push("11"),t.has("4aug")&&b.push("#11"),t.has("6min")&&b.push("b13"),t.has("6")&&!D.includes("Sesta")&&b.push("13"),t.has("6aug")&&b.push("#13");const w={thirdQuality:c,fifthQuality:g,seventhQuality:D,extensions:b},S=G(m,!1,!1,!1)[0],T=n(f,y,h);i.push([j,h,f,y,Array.from(t),w,S,T])}i.sort((r,m)=>{const t=r[7],h=m[7];return t-h});let o=0;o=0;const l=i[o];return{root:l[0],base:l[1],quality:l[2],inversion:l[3],intervals:l[4],detailedAnalysis:l[5],rootName:l[6],options:i}}function J(d,a=!1){const e=te(d,a),i=e.rootName,s=`${i}${e.base}${Array.isArray(e.quality)&&e.quality.length>0?e.quality.join(""):""}${e.inversion}`,n=e.options.map(o=>{const l=o[6],r=o[1],m=Array.isArray(o[2])?o[2]:[],t=m.length>0?m.join(""):"",h=o[3]||"";return{chordName:`${l}${r}${t}${h}`,root:o[0].normalizeToModulo(),components:{rootName:l,base:r,quality:m,inversion:h,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}});return{chordName:s,root:e.root.normalizeToModulo(),rootName:i,base:e.base,quality:e.quality,inversion:e.inversion,intervals:e.intervals,detailedAnalysis:e.detailedAnalysis,options:n}}function G(d,a=!0,e=!1,i=!0,s=!1){const l=a?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],r=new A([0,2,4,5,7,9,11],12,12),m=new B([2,2,1,2,2,2,1],12,0);let t=q(r,d),h=t[0],f=t[1],y=Math.floor(f.data[0]/f.modulo)*f.modulo;const j=f.sum(-y);let c=0,g=j,D=0;if(s&&(D=H(J(g,!0).root,g).data[0],g=g.rototranslate(D)),h.element(c)<g.data[0])for(;h.element(c)<g.data[0];)c++;else for(;h.element(c)>=g.data[0];)c--;const b=g.degreeFunction();let w=b.degreeFunction.map(u=>u.degree);const S=b.intervalTypes,T=w.indexOf(6);T!==-1&&S.has("7dim")&&(w[T]=5);const P=w.indexOf(2);P!==-1&&S.has("3dim")&&(w[P]=1);const p=w.indexOf(2);p!==-1&&S.has("3aug")&&(w[p]=3);const E=w.indexOf(3);E!==-1&&(S.has("5dim")||S.has("4aug"))&&S.has("7min")&&(w[E]=4);let R=[],z=w,Q=1/0,U=c,x=1/0;for(let u=-1;u<=1;u++){let $=[],I=0,k=c+u;for(let C=0;C<g.data.length;C++){const ae=Math.floor((g.data[C]-g.data[0])/g.modulo)*7,Z=g.data[C]-h.element(w[C]+k+ae);$[C]=Z,[0,2,4].includes(w[C])?I+=2*Z:[6].includes(w[C])&&(I+=Z)}const O=Math.abs($[0]),L=O<x,se=O===x&&Math.abs(I)<Math.abs(Q);(L||se)&&(Q=I,R=$,U=k,x=O)}let M=R,N=z;if(c=U,i)for(let u=0;u<M.length;u++){const $=m.element(N[u]+c),I=m.element(N[u]+c-1);Math.abs(M[u])>=$&&Math.sign(M[u])==1?(M[u]-=m.element(N[u]+c),N[u]+=1):Math.abs(M[u])>=I&&Math.sign(M[u])==-1&&(M[u]+=m.element(N[u]+c-1),N[u]-=1)}let F=[];for(let u=0;u<N.length;u++){const $=v(u-D,M.length),I=M[$],k=l[v(N[$]+c,7)];if(e){const O=Math.round(I*50);O!==0?F[u]=`${k} ${O>0?"â†‘":"â†“"}${Math.abs(O)}Â¢`:F[u]=k}else{const O=Math.round(I);if(Math.abs(I)<1&&I!==0)F[u]=k+(I>0?"ð„²":"ð„³");else if(O!==0){const L=O>0?"â™¯":"â™­";F[u]=k+L.repeat(Math.min(Math.abs(O),2))}else F[u]=k}}return F}const W=new Map;self.onmessage=d=>{const{activeNotes:a,selectedIndex:e,bassAsRoot:i,useEnharmonic:s,requestId:n}=d.data,o=`${a.join(",")}|${e}|${i}|${s}`;if(W.has(o)){self.postMessage({...W.get(o),requestId:n});return}const l=new Set(a);if(l.size===0){self.postMessage({requestId:n,chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const r=Array.from(l).sort((y,j)=>y-j),m=new A(r,12,12).normalizeToModulo();let t=[];try{t=G(m,!0,!1,s,!1)}catch(y){console.error(y)}const h=new Map;r.forEach((y,j)=>{t[j]&&h.set(y,t[j])});let f=[];try{f=J(m,!i).options}catch(y){console.error(y)}if(f.length>0&&f[e]){const y=f[e],{root:j,components:c,detailedAnalysis:g}=y,D=H(j,m).data[0],b=m.rototranslate(D,m.data.length,!1),w=G(b,!0,!1,s,!1),S=(x,M)=>(x%M+M)%M;for(let x=0;x<w.length;x++){const M=S(b.data[x],12);r.forEach(N=>{S(N,12)===M&&w[x]&&h.set(N,w[x])})}const T=new Map,P=j.data[0],p=(x,M)=>{r.forEach(N=>{const F=S(N,12),u=S(F-P,12);x.includes(u)&&T.set(N,M)})};r.forEach(x=>T.set(x,"ext")),p([0],"root");const{thirdQuality:E,fifthQuality:R,seventhQuality:z}=g;E==="Maggiore"?p([4],"third"):E==="Minore"?p([3],"third"):E==="Sus 2"?p([2],"third"):E==="Sus 4"&&p([5],"third"),R==="Giusta"?p([7],"fifth"):R==="Aumentata"?p([8],"fifth"):R==="Diminuita"&&p([6],"fifth"),z==="Mag 7"?p([11],"seventh"):z==="Min 7"?p([10],"seventh"):z==="Sesta/Dim"&&p([9],"seventh"),p([1],"b9"),p([2],"9"),p([5],"11"),p([6],"#11"),p([8],"b13"),p([9],"13");const Q=Array.from(T.values()),U={chordOptions:f,analysis:{rootName:c.rootName,quality:g.thirdQuality,stability:g.fifthQuality,function:g.seventhQuality,extensions:g.extensions,intervals:Array.from(T),noteNames:Array.from(h),flags:{isRootActive:Q.includes("root"),isThirdActive:Q.includes("third"),isFifthActive:Q.includes("fifth"),isSeventhActive:Q.includes("seventh")}}};W.set(o,U),self.postMessage({...U,requestId:n})}else{const y=new Map;r.forEach(c=>y.set(c,"active"));const j={chordOptions:f,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:Array.from(y),noteNames:Array.from(h),flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}};W.set(o,j),self.postMessage({...j,requestId:n})}}})();
