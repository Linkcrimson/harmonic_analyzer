(function(){"use strict";function v(r,a){if(a<0)return-v(-r,-a);let e=(r%a+a)%a;return e<0&&(e+=a),e}function K(r,a){return a===0?r:K(a,r%a)}function X(r,a){return r*a/K(r,a)}class Y{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.offset=i}}class y{constructor(a,e=12,i=12){this.data=a,this.modulo=e,this.span=i}element(a){let e=this.data.length,i=0;return a>=0?i=this.data[v(a,e)]+Math.abs(this.span)*~~(a/e):i=this.data[v(a,e)]+Math.abs(this.span)*(~~((a+1)/e)-1),i}rototranslate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new y(s,this.modulo,this.span)}spanUpdate(){let a=this.data[0],e=this.data[0],i=this.modulo;for(let n=0;n<this.data.length;n++)this.data[n]>a&&(a=this.data[n]),this.data[n]<e&&(e=this.data[n]);let s=a-e;if(i<=s)for(;i<=s;)i+=this.modulo;this.span=i}invert(a=!0){let e=this.data.slice();for(let i=0;i<e.length;i++)e[i]*=-1;return a&&(this.data=e),new y(e,this.modulo,this.span)}negative(a=10,e=!0,i=!0){let s=this.data.slice(),n=a;if(e){for(let l=0;l<s.length;l++)s[l]*=2;n=a*2-1}for(let l=0;l<s.length;l++)s[l]-=n;for(let l=0;l<s.length;l++)s[l]*=-1;for(let l=0;l<s.length;l++)s[l]+=n;if(e)for(let l=0;l<s.length;l++)s[l]/=2;s.sort(function(l,d){return l-d});let o=new y(s,this.modulo,this.span);return o.rototranslate(-1),i&&(this.data=s),o}options(a){let e=[],i=this.data.length;for(let s=a-i;s<a+i;s++){const n=this.rototranslate(s,i,!1);e.push(n)}return e}selectFromPosition(a){let e=[];for(let s=0;s<a.data.length;s++)e.push(this.element(a.data[s]));let i=new y(e,this.modulo,this.span);return i.spanUpdate(),i}freeInvert(a=1){if(this.data.length===0)return this;let e=new Array(this.data.length);switch(a){case 0:{const i=this.data[0];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 2:{const i=this.data[this.data.length-1];for(let s=0;s<this.data.length;s++)e[s]=2*i-this.data[s];break}case 1:default:e=this.data.slice().reverse();break}return new y(e,this.modulo,this.span)}sum(a=0){let e=[...this.data];for(let i=0;i<this.data.length;i++)e[i]+=a;return new y(e,this.modulo,this.span)}toZero(a=!1){let e=new y(this.data.slice(),this.modulo,this.span),i=e.data[0];for(let s=0;s<e.data.length;s++)e.data[s]=v(e.data[s]-i,e.modulo);return e.data.sort((s,n)=>s-n),e.spanUpdate(),a&&(this.data=e.data,this.span=e.span,this.modulo=e.modulo),e}isNote(a){for(let e=0;e<this.data.length;e++)if(v(this.data[e],this.modulo)===v(a,this.modulo))return!0;return!1}isAvoid(a){if(this.isNote(a))return!1;const e=this.modulo/2;for(let i=1;i<this.data.length;i++){const s=v(this.data[i],this.modulo);if(v(a-s,this.modulo)===e)return!0}return!1}degreeFunction(){let a=this.sum(-this.data[0]).normalizeToModulo(),e=a.data,i=a.toBinary().data,s=Array.from({length:this.data.length},(t,h)=>h);for(let t=1;t<e.length;t++)e[t]=v(Math.round(e[t]*12/this.modulo),12);let n=new Array(this.data.length);n[0]=0;let o=new Set,l=new Set;l.add(0);for(const t of s.slice())e[t]==0&&(n[t]=0,o.add("f"),s.splice(s.indexOf(t),1)),e[t]==4&&(n[t]=2,l.add(4),o.add("3maj"),s.splice(s.indexOf(t),1)),e[t]==7&&(n[t]=4,l.add(7),o.add("5"),s.splice(s.indexOf(t),1)),e[t]==11&&(n[t]=6,l.add(11),o.add("7maj"),s.splice(s.indexOf(t),1));if(!o.has("3maj")&&i[3]==!0){for(const t of s)if(e[t]==3){n[t]=2,l.add(3),o.add("3min"),s.splice(s.indexOf(t),1);break}}if(!o.has("5")&&!o.has("3min")&&i[8]==!0){for(const t of s)if(e[t]==8){n[t]=4,l.add(8),o.add("5aug"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&i[2]==!0){for(const t of s)if(e[t]==2){n[t]=2,l.add(2),o.add("3dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&i[5]==!0){for(const t of s)if(e[t]==5){n[t]=2,l.add(5),o.add("3aug"),s.splice(s.indexOf(t),1);break}}const d=i[10]==!0;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||d)&&i[6]==!0){for(const t of s)if(e[t]==6){n[t]=4,l.add(6),o.add("5dim"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&i[10]==!0){for(const t of s)if(e[t]==10){n[t]=6,l.add(10),o.add("7min"),s.splice(s.indexOf(t),1);break}}if(!o.has("7maj")&&!o.has("7min")&&i[9]==!0){for(const t of s)if(e[t]==9){n[t]=6,l.add(9),o.add("7dim"),s.splice(s.indexOf(t),1);break}}for(const t of s)e[t]<4?(n[t]=1,e[t]==1?o.add("2min"):e[t]==2?o.add("2"):e[t]==3&&o.add("2aug")):e[t]>4&&e[t]<7?(n[t]=3,e[t]==5?o.add("4"):e[t]==6&&o.add("4aug")):e[t]>7&&e[t]<11&&(n[t]=5,e[t]==8?o.add("6min"):e[t]==9?o.add("6"):e[t]==10&&o.add("6aug"));return{degreeFunction:this.data.map((t,h)=>({degree:n[h]})),intervalTypes:o,baseChord:l}}isExtension(a){const{baseChord:e}=this.degreeFunction(),i=Math.round(v(a-this.data[0],this.modulo)*12/this.modulo);return!e.has(i)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((e,i)=>{const s=parseInt(e,10),n=parseInt(i,10);return s-n})}getDegrees(){return this.degreeFunction().degreeFunction.map(a=>a.degree)}normalizeToModulo(){const a=this.data.map(n=>v(n,this.modulo)),e=a[0],s=a.map(n=>n<e?n+this.modulo:n).sort((n,o)=>n-o);return new y(s,this.modulo,this.span)}toBinary(){let a=new Y(new Array(this.span).fill(!1),this.modulo,this.data[0]),e=this.sum(-this.data[0]);for(const i of e.data){let s=v(i,this.span);a.data[s]=!0}return a}}function q(r,a){if(r.modulo===a.modulo)return[r,a];let e=X(r.modulo,a.modulo),i=[];for(let n=0;n<r.data.length;n++)i.push(e/r.modulo*r.data[n]);let s=[];for(let n=0;n<a.data.length;n++)s.push(e/a.modulo*a.data[n]);return[new y(i,e,e/r.modulo*r.span),new y(s,e,e/a.modulo*a.span)]}function H(r,a){a.spanUpdate();let e=new y([],a.data.length,a.data.length),i=Math.floor(r.data[0]/r.modulo);if(a.element(i)>r.data[0])for(;a.element(i)>r.data[0];)i--;else if(a.element(i)<r.data[0]){for(;a.element(i)<r.data[0];)i++;i--}for(let s=0;s<r.data.length;s++){for(;a.element(i)<r.data[s];)i++;if(a.element(i)==r.data[s])e.data.push(i);else throw new Error("Error: Impossible finding element: "+r.data[s]+" nella scale."+a.data)}return e}class C{constructor(a,e=12,i=0){this.data=a,this.modulo=e,this.offset=i}element(a){return this.data[v(a,this.data.length)]}rotate(a,e=this.data.length,i=!0){let s=new Array(e);for(let n=0;n<e;n++)s[n]=this.element(a+n);return i&&(this.data=s),new C(s,this.modulo,this.offset)}invert(a=!0){let e=this.data.length,i=new Array(e);for(let s=0;s<e;s++)i[s]=this.data[e-1-s];return a&&(this.data=i),new C(i,this.modulo,this.offset)}singleMirror(a,e,i=!0){let s=this.data,n=s.length;if(a=v(a,n),e)for(let o=0;o<a/2;++o){let l=s[o];s[o]=s[a-1-o],s[a-1-o]=l}else{let o=a+(n-a)/2;for(let l=a;l<o;++l){let d=s[l];s[l]=s[n-1-(l-a)],s[n-1-(l-a)]=d}}return i&&(this.data=s),new C(s,this.modulo,this.offset)}}const V={intervals:new C([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function _({intervals:r=new C([2,2,1,2,2,2,1],12,0),root:a=0,modo:e=0,grado:i=0,isInvert:s=!1,isMirror:n=!1,mirrorPos:o=0,mirrorLeft:l=!1}=V){r.offset=a;let d=r.rotate(e);s&&(d=d.invert()),n&&(d=d.singleMirror(o,l));let m=ee(d);return m.spanUpdate(),m.rototranslate(i),m}function ee(r){let a=r.data.length,e=new Array(a),i=r.offset;for(let s=0;s<a;s++)e[s]=i,i+=r.data[s];return i-=r.offset,new y(e,r.modulo,i)}_();function te(r,a=!1){let e=r;e=e.sum(-r.data[0]);for(let d=1;d<e.data.length;d++)e.data[d]=v(e.data[d],e.modulo);e.data.sort((d,m)=>d-m),e.data=[...new Set(e.data)],e=e.sum(+r.data[0]);let i=[],s=1;a&&(s=e.data.length);const n=(d,m,t)=>{let h=0;return h+=d.length,m!==""&&(h+=2),(d.includes("b9")||d.includes("#9")||d.includes("b13"))&&(h+=2),t.includes("+")&&(h+=2),d.includes("omit3")&&(h+=3),d.includes("omit5")&&(h+=2),(d.includes("add9")||d.includes("addb9")||d.includes("add#9")||d.includes("add11")||d.includes("add13")||d.includes("addb13")||d.includes("add#13"))&&(h+=3),(d.includes("sus2")||d.includes("sus4"))&&(h+=2),h};for(let d=0;d<s;d++){let m=e.rototranslate(d,e.data.length,!1),t=new Set(m.getIntervalTypes()),h="",f=[],w="";t.has("5aug")&&(h="+"),t.has("3min")?t.has("5dim")?h="dim":h="-":!t.has("3maj")&&!t.has("3min")&&t.has("3dim")&&t.has("3aug")&&(h="5"),t.has("7maj")?t.has("2")?h+="maj9":h+="maj7":t.has("7min")?(h=="dim"&&(h="Ã¸"),t.has("2")?h+="9":h+="7"):t.has("7dim")&&(h!="dim"?h+="6":h+="7"),t.has("4")&&t.has("3dim")?f.push("sus2/4"):t.has("3aug")?f.push("sus4"):t.has("3dim")&&f.push("sus2"),t.has("5dim")&&!t.has("5")&&!t.has("5aug")&&!h.startsWith("dim")&&!h.startsWith("Ã¸")&&f.push("b5"),t.has("2min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb9"):f.push("b9")),t.has("2")&&(h.includes("9")||(!t.has("7maj")&&!t.has("7min")?f.push("add9"):f.push("9"))),t.has("2aug")&&(!t.has("7maj")&&!t.has("7min")?f.push("add#9"):f.push("#9")),t.has("4")&&!t.has("3dim")&&(!t.has("7maj")&&!t.has("7min")||t.has("3maj")?f.push("add11"):f.push("11")),t.has("4aug")&&!f.includes("b5")&&(!t.has("7maj")&&!t.has("7min")&&!t.has("7dim")?f.push("add#11"):f.push("#11")),t.has("6min")&&(!t.has("7maj")&&!t.has("7min")?f.push("addb13"):f.push("b13")),t.has("6")&&(!t.has("7maj")&&!t.has("7min")?f.push("add13"):f.push("13")),t.has("6aug")&&f.push("#13"),!t.has("3maj")&&!t.has("3min")&&!t.has("3aug")&&!t.has("3dim")&&f.push("omit3"),!t.has("5")&&!t.has("5dim")&&!t.has("5aug")&&f.push("omit5");const B=new y([m.data[0]],r.modulo,r.span);if(a&&d!==0){const A=v(e.data.length-d,e.data.length);w=`/${G(m,!1,!1,!0)[A]}`}let c="Indefinito";t.has("3maj")?c="Maggiore":t.has("3min")?c="Minore":t.has("3dim")||t.has("2")?c="Sus 2":(t.has("3aug")||t.has("4"))&&(c="Sus 4");let g="Omessa";t.has("5")?g="Giusta":t.has("5aug")?g="Aumentata":t.has("5dim")&&(g="Diminuita");let N="Triade";t.has("7maj")?N="Mag 7":t.has("7min")?N="Min 7":(t.has("7dim")||t.has("6"))&&(N="Sesta/Dim");const M=[];t.has("2min")&&M.push("b9"),t.has("2")&&!c.includes("Sus")&&M.push("9"),t.has("2aug")&&M.push("#9"),t.has("4")&&!c.includes("Sus")&&M.push("11"),t.has("4aug")&&M.push("#11"),t.has("6min")&&M.push("b13"),t.has("6")&&!N.includes("Sesta")&&M.push("13"),t.has("6aug")&&M.push("#13");const p={thirdQuality:c,fifthQuality:g,seventhQuality:N,extensions:M},j=G(m,!1,!1,!1)[0],Q=n(f,w,h);i.push([B,h,f,w,Array.from(t),p,j,Q])}i.sort((d,m)=>{const t=d[7],h=m[7];return t-h});let o=0;o=0;const l=i[o];return{root:l[0],base:l[1],quality:l[2],inversion:l[3],intervals:l[4],detailedAnalysis:l[5],rootName:l[6],options:i}}function J(r,a=!1){const e=te(r,a),i=e.rootName,s=`${i}${e.base}${Array.isArray(e.quality)&&e.quality.length>0?e.quality.join(""):""}${e.inversion}`,n=e.options.map(o=>{const l=o[6],d=o[1],m=Array.isArray(o[2])?o[2]:[],t=m.length>0?m.join(""):"",h=o[3]||"";return{chordName:`${l}${d}${t}${h}`,root:o[0].normalizeToModulo(),components:{rootName:l,base:d,quality:m,inversion:h,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}});return{chordName:s,root:e.root.normalizeToModulo(),rootName:i,base:e.base,quality:e.quality,inversion:e.inversion,intervals:e.intervals,detailedAnalysis:e.detailedAnalysis,options:n}}function G(r,a=!0,e=!1,i=!0,s=!1){const l=a?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],d=new y([0,2,4,5,7,9,11],12,12),m=new C([2,2,1,2,2,2,1],12,0);let t=q(d,r),h=t[0],f=t[1],w=Math.floor(f.data[0]/f.modulo)*f.modulo;const B=f.sum(-w);let c=0,g=B,N=0;if(s&&(N=H(J(g,!0).root,g).data[0],g=g.rototranslate(N)),h.element(c)<g.data[0])for(;h.element(c)<g.data[0];)c++;else for(;h.element(c)>=g.data[0];)c--;const M=g.degreeFunction();let p=M.degreeFunction.map(u=>u.degree);const j=M.intervalTypes,Q=p.indexOf(6);Q!==-1&&j.has("7dim")&&(p[Q]=5);const A=p.indexOf(2);A!==-1&&j.has("3dim")&&(p[A]=1);const E=p.indexOf(2);E!==-1&&j.has("3aug")&&(p[E]=3);const P=p.indexOf(3);P!==-1&&(j.has("5dim")||j.has("4aug"))&&j.has("7min")&&(p[P]=4);let R=[],z=p,U=1/0,x=c,D=1/0;for(let u=-1;u<=1;u++){let F=[],S=0,$=c+u;for(let k=0;k<g.data.length;k++){const ae=Math.floor((g.data[k]-g.data[0])/g.modulo)*7,Z=g.data[k]-h.element(p[k]+$+ae);F[k]=Z,[0,2,4].includes(p[k])?S+=2*Z:[6].includes(p[k])&&(S+=Z)}const I=Math.abs(F[0]),L=I<D,se=I===D&&Math.abs(S)<Math.abs(U);(L||se)&&(U=S,R=F,x=$,D=I)}let b=R,O=z;if(c=x,i)for(let u=0;u<b.length;u++){const F=m.element(O[u]+c),S=m.element(O[u]+c-1);Math.abs(b[u])>=F&&Math.sign(b[u])==1?(b[u]-=m.element(O[u]+c),O[u]+=1):Math.abs(b[u])>=S&&Math.sign(b[u])==-1&&(b[u]+=m.element(O[u]+c-1),O[u]-=1)}let T=[];for(let u=0;u<O.length;u++){const F=v(u-N,b.length),S=b[F],$=l[v(O[F]+c,7)];if(e){const I=Math.round(S*50);I!==0?T[u]=`${$} ${I>0?"â†‘":"â†“"}${Math.abs(I)}Â¢`:T[u]=$}else{const I=Math.round(S);if(Math.abs(S)<1&&S!==0)T[u]=$+(S>0?"ð„²":"ð„³");else if(I!==0){const L=I>0?"â™¯":"â™­";T[u]=$+L.repeat(Math.min(Math.abs(I),2))}else T[u]=$}}return T}const W=new Map;self.onmessage=r=>{const{activeNotes:a,selectedIndex:e,bassAsRoot:i,useEnharmonic:s}=r.data,n=`${a.join(",")}|${e}|${i}|${s}`;if(W.has(n)){self.postMessage(W.get(n));return}const o=new Set(a);if(o.size===0){self.postMessage({chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const l=Array.from(o).sort((f,w)=>f-w),d=new y(l,12,12).normalizeToModulo();let m=[];try{m=G(d,!0,!1,s,!1)}catch(f){console.error(f)}const t=new Map;l.forEach((f,w)=>{m[w]&&t.set(f,m[w])});let h=[];try{h=J(d,!i).options}catch(f){console.error(f)}if(h.length>0&&h[e]){const f=h[e],{root:w,components:B,detailedAnalysis:c}=f,g=H(w,d).data[0],N=d.rototranslate(g,d.data.length,!1),M=G(N,!0,!1,s,!1),p=(x,D)=>(x%D+D)%D;for(let x=0;x<M.length;x++){const D=p(N.data[x],12);l.forEach(b=>{p(b,12)===D&&M[x]&&t.set(b,M[x])})}const j=new Map,Q=w.data[0],A=(x,D)=>{l.forEach(b=>{const O=p(b,12),T=p(O-Q,12);x.includes(T)&&j.set(b,D)})};l.forEach(x=>j.set(x,"ext")),A([0],"root");const{thirdQuality:E,fifthQuality:P,seventhQuality:R}=c;E==="Maggiore"?A([4],"third"):E==="Minore"?A([3],"third"):E==="Sus 2"?A([2],"third"):E==="Sus 4"&&A([5],"third"),P==="Giusta"?A([7],"fifth"):P==="Aumentata"?A([8],"fifth"):P==="Diminuita"&&A([6],"fifth"),R==="Mag 7"?A([11],"seventh"):R==="Min 7"?A([10],"seventh"):R==="Sesta/Dim"&&A([9],"seventh");const z=Array.from(j.values()),U={chordOptions:h,analysis:{rootName:B.rootName,quality:c.thirdQuality,stability:c.fifthQuality,function:c.seventhQuality,extensions:c.extensions,intervals:j,noteNames:t,flags:{isRootActive:z.includes("root"),isThirdActive:z.includes("third"),isFifthActive:z.includes("fifth"),isSeventhActive:z.includes("seventh")}}};W.set(n,U),self.postMessage(U)}else{const f=new Map;l.forEach(B=>f.set(B,"active"));const w={chordOptions:h,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:f,noteNames:t,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}};W.set(n,w),self.postMessage(w)}}})();
