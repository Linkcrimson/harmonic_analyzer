(function(){"use strict";function v(h,a){if(a<0)return-v(-h,-a);let t=(h%a+a)%a;return t<0&&(t+=a),t}function Z(h,a){return a===0?h:Z(a,h%a)}function K(h,a){return h*a/Z(h,a)}class X{constructor(a,t=12,i=12){this.data=a,this.modulo=t,this.offset=i}}class w{constructor(a,t=12,i=12){this.data=a,this.modulo=t,this.span=i}element(a){let t=this.data.length,i=0;return a>=0?i=this.data[v(a,t)]+Math.abs(this.span)*~~(a/t):i=this.data[v(a,t)]+Math.abs(this.span)*(~~((a+1)/t)-1),i}rototranslate(a,t=this.data.length,i=!0){let s=new Array(t);for(let n=0;n<t;n++)s[n]=this.element(a+n);return i&&(this.data=s),new w(s,this.modulo,this.span)}spanUpdate(){let a=this.data[0],t=this.data[0],i=this.modulo;for(let n=0;n<this.data.length;n++)this.data[n]>a&&(a=this.data[n]),this.data[n]<t&&(t=this.data[n]);let s=a-t;if(i<=s)for(;i<=s;)i+=this.modulo;this.span=i}invert(a=!0){let t=this.data.slice();for(let i=0;i<t.length;i++)t[i]*=-1;return a&&(this.data=t),new w(t,this.modulo,this.span)}negative(a=10,t=!0,i=!0){let s=this.data.slice(),n=a;if(t){for(let l=0;l<s.length;l++)s[l]*=2;n=a*2-1}for(let l=0;l<s.length;l++)s[l]-=n;for(let l=0;l<s.length;l++)s[l]*=-1;for(let l=0;l<s.length;l++)s[l]+=n;if(t)for(let l=0;l<s.length;l++)s[l]/=2;s.sort(function(l,r){return l-r});let o=new w(s,this.modulo,this.span);return o.rototranslate(-1),i&&(this.data=s),o}options(a){let t=[],i=this.data.length;for(let s=a-i;s<a+i;s++){const n=this.rototranslate(s,i,!1);t.push(n)}return t}selectFromPosition(a){let t=[];for(let s=0;s<a.data.length;s++)t.push(this.element(a.data[s]));let i=new w(t,this.modulo,this.span);return i.spanUpdate(),i}freeInvert(a=1){if(this.data.length===0)return this;let t=new Array(this.data.length);switch(a){case 0:{const i=this.data[0];for(let s=0;s<this.data.length;s++)t[s]=2*i-this.data[s];break}case 2:{const i=this.data[this.data.length-1];for(let s=0;s<this.data.length;s++)t[s]=2*i-this.data[s];break}case 1:default:t=this.data.slice().reverse();break}return new w(t,this.modulo,this.span)}sum(a=0){let t=[...this.data];for(let i=0;i<this.data.length;i++)t[i]+=a;return new w(t,this.modulo,this.span)}toZero(a=!1){let t=new w(this.data.slice(),this.modulo,this.span),i=t.data[0];for(let s=0;s<t.data.length;s++)t.data[s]=v(t.data[s]-i,t.modulo);return t.data.sort((s,n)=>s-n),t.spanUpdate(),a&&(this.data=t.data,this.span=t.span,this.modulo=t.modulo),t}isNote(a){for(let t=0;t<this.data.length;t++)if(v(this.data[t],this.modulo)===v(a,this.modulo))return!0;return!1}isAvoid(a){if(this.isNote(a))return!1;const t=this.modulo/2;for(let i=1;i<this.data.length;i++){const s=v(this.data[i],this.modulo);if(v(a-s,this.modulo)===t)return!0}return!1}degreeFunction(){let a=this.sum(-this.data[0]).normalizeToModulo(),t=a.data,i=a.toBinary().data,s=Array.from({length:this.data.length},(e,d)=>d);for(let e=1;e<t.length;e++)t[e]=v(Math.round(t[e]*12/this.modulo),12);let n=new Array(this.data.length);n[0]=0;let o=new Set,l=new Set;l.add(0);for(const e of s.slice())t[e]==0&&(n[e]=0,o.add("f"),s.splice(s.indexOf(e),1)),t[e]==4&&(n[e]=2,l.add(4),o.add("3maj"),s.splice(s.indexOf(e),1)),t[e]==7&&(n[e]=4,l.add(7),o.add("5"),s.splice(s.indexOf(e),1)),t[e]==11&&(n[e]=6,l.add(11),o.add("7maj"),s.splice(s.indexOf(e),1));if(!o.has("3maj")&&i[3]==!0){for(const e of s)if(t[e]==3){n[e]=2,l.add(3),o.add("3min"),s.splice(s.indexOf(e),1);break}}if(!o.has("5")&&!o.has("3min")&&i[8]==!0){for(const e of s)if(t[e]==8){n[e]=4,l.add(8),o.add("5aug"),s.splice(s.indexOf(e),1);break}}if(!o.has("3maj")&&!o.has("3min")&&i[2]==!0){for(const e of s)if(t[e]==2){n[e]=2,l.add(2),o.add("3dim"),s.splice(s.indexOf(e),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&i[5]==!0){for(const e of s)if(t[e]==5){n[e]=2,l.add(5),o.add("3aug"),s.splice(s.indexOf(e),1);break}}const r=i[10]==!0;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||r)&&i[6]==!0){for(const e of s)if(t[e]==6){n[e]=4,l.add(6),o.add("5dim"),s.splice(s.indexOf(e),1);break}}if(!o.has("7maj")&&i[10]==!0){for(const e of s)if(t[e]==10){n[e]=6,l.add(10),o.add("7min"),s.splice(s.indexOf(e),1);break}}if(!o.has("7maj")&&!o.has("7min")&&i[9]==!0){for(const e of s)if(t[e]==9){n[e]=6,l.add(9),o.add("7dim"),s.splice(s.indexOf(e),1);break}}for(const e of s)t[e]<4?(n[e]=1,t[e]==1?o.add("2min"):t[e]==2?o.add("2"):t[e]==3&&o.add("2aug")):t[e]>4&&t[e]<7?(n[e]=3,t[e]==5?o.add("4"):t[e]==6&&o.add("4aug")):t[e]>7&&t[e]<11&&(n[e]=5,t[e]==8?o.add("6min"):t[e]==9?o.add("6"):t[e]==10&&o.add("6aug"));return{degreeFunction:this.data.map((e,d)=>({degree:n[d]})),intervalTypes:o,baseChord:l}}isExtension(a){const{baseChord:t}=this.degreeFunction(),i=Math.round(v(a-this.data[0],this.modulo)*12/this.modulo);return!t.has(i)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((t,i)=>{const s=parseInt(t,10),n=parseInt(i,10);return s-n})}getDegrees(){return this.degreeFunction().degreeFunction.map(a=>a.degree)}normalizeToModulo(){const a=this.data.map(n=>v(n,this.modulo)),t=a[0],s=a.map(n=>n<t?n+this.modulo:n).sort((n,o)=>n-o);return new w(s,this.modulo,this.span)}toBinary(){let a=new X(new Array(this.span).fill(!1),this.modulo,this.data[0]),t=this.sum(-this.data[0]);for(const i of t.data){let s=v(i,this.span);a.data[s]=!0}return a}}function Y(h,a){if(h.modulo===a.modulo)return[h,a];let t=K(h.modulo,a.modulo),i=[];for(let n=0;n<h.data.length;n++)i.push(t/h.modulo*h.data[n]);let s=[];for(let n=0;n<a.data.length;n++)s.push(t/a.modulo*a.data[n]);return[new w(i,t,t/h.modulo*h.span),new w(s,t,t/a.modulo*a.span)]}function H(h,a){a.spanUpdate();let t=new w([],a.data.length,a.data.length),i=Math.floor(h.data[0]/h.modulo);if(a.element(i)>h.data[0])for(;a.element(i)>h.data[0];)i--;else if(a.element(i)<h.data[0]){for(;a.element(i)<h.data[0];)i++;i--}for(let s=0;s<h.data.length;s++){for(;a.element(i)<h.data[s];)i++;if(a.element(i)==h.data[s])t.data.push(i);else throw new Error("Error: Impossible finding element: "+h.data[s]+" nella scale."+a.data)}return t}class C{constructor(a,t=12,i=0){this.data=a,this.modulo=t,this.offset=i}element(a){return this.data[v(a,this.data.length)]}rotate(a,t=this.data.length,i=!0){let s=new Array(t);for(let n=0;n<t;n++)s[n]=this.element(a+n);return i&&(this.data=s),new C(s,this.modulo,this.offset)}invert(a=!0){let t=this.data.length,i=new Array(t);for(let s=0;s<t;s++)i[s]=this.data[t-1-s];return a&&(this.data=i),new C(i,this.modulo,this.offset)}singleMirror(a,t,i=!0){let s=this.data,n=s.length;if(a=v(a,n),t)for(let o=0;o<a/2;++o){let l=s[o];s[o]=s[a-1-o],s[a-1-o]=l}else{let o=a+(n-a)/2;for(let l=a;l<o;++l){let r=s[l];s[l]=s[n-1-(l-a)],s[n-1-(l-a)]=r}}return i&&(this.data=s),new C(s,this.modulo,this.offset)}}const q={intervals:new C([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function V({intervals:h=new C([2,2,1,2,2,2,1],12,0),root:a=0,modo:t=0,grado:i=0,isInvert:s=!1,isMirror:n=!1,mirrorPos:o=0,mirrorLeft:l=!1}=q){h.offset=a;let r=h.rotate(t);s&&(r=r.invert()),n&&(r=r.singleMirror(o,l));let u=_(r);return u.spanUpdate(),u.rototranslate(i),u}function _(h){let a=h.data.length,t=new Array(a),i=h.offset;for(let s=0;s<a;s++)t[s]=i,i+=h.data[s];return i-=h.offset,new w(t,h.modulo,i)}V();function tt(h,a=!1){let t=h;t=t.sum(-h.data[0]);for(let r=1;r<t.data.length;r++)t.data[r]=v(t.data[r],t.modulo);t.data.sort((r,u)=>r-u),t.data=[...new Set(t.data)],t=t.sum(+h.data[0]);let i=[],s=1;a&&(s=t.data.length);const n=(r,u,e)=>{let d=0;return d+=r.length,u!==""&&(d+=2),(r.includes("b9")||r.includes("#9")||r.includes("b13"))&&(d+=2),e.includes("+")&&(d+=2),r.includes("omit3")&&(d+=3),r.includes("omit5")&&(d+=2),(r.includes("add9")||r.includes("addb9")||r.includes("add#9")||r.includes("add11")||r.includes("add13")||r.includes("addb13")||r.includes("add#13"))&&(d+=3),(r.includes("sus2")||r.includes("sus4"))&&(d+=2),d};for(let r=0;r<s;r++){let u=t.rototranslate(r,t.data.length,!1),e=new Set(u.getIntervalTypes()),d="",f=[],E="";e.has("5aug")&&(d="+"),e.has("3min")?e.has("5dim")?d="dim":d="-":!e.has("3maj")&&!e.has("3min")&&e.has("3dim")&&e.has("3aug")&&(d="5"),e.has("7maj")?e.has("2")?d+="maj9":d+="maj7":e.has("7min")?(d=="dim"&&(d="Ã¸"),e.has("2")?d+="9":d+="7"):e.has("7dim")&&(d!="dim"?d+="6":d+="7"),e.has("4")&&e.has("3dim")?f.push("sus2/4"):e.has("3aug")?f.push("sus4"):e.has("3dim")&&f.push("sus2"),e.has("5dim")&&!e.has("5")&&!e.has("5aug")&&!d.startsWith("dim")&&!d.startsWith("Ã¸")&&f.push("b5"),e.has("2min")&&(!e.has("7maj")&&!e.has("7min")?f.push("addb9"):f.push("b9")),e.has("2")&&(d.includes("9")||(!e.has("7maj")&&!e.has("7min")?f.push("add9"):f.push("9"))),e.has("2aug")&&(!e.has("7maj")&&!e.has("7min")?f.push("add#9"):f.push("#9")),e.has("4")&&!e.has("3dim")&&(!e.has("7maj")&&!e.has("7min")||e.has("3maj")?f.push("add11"):f.push("11")),e.has("4aug")&&!f.includes("b5")&&(!e.has("7maj")&&!e.has("7min")&&!e.has("7dim")?f.push("add#11"):f.push("#11")),e.has("6min")&&(!e.has("7maj")&&!e.has("7min")?f.push("addb13"):f.push("b13")),e.has("6")&&(!e.has("7maj")&&!e.has("7min")?f.push("add13"):f.push("13")),e.has("6aug")&&f.push("#13"),!e.has("3maj")&&!e.has("3min")&&!e.has("3aug")&&!e.has("3dim")&&f.push("omit3"),!e.has("5")&&!e.has("5dim")&&!e.has("5aug")&&f.push("omit5");const I=new w([u.data[0]],h.modulo,h.span);if(a&&r!==0){const O=v(t.data.length-r,t.data.length);E=`/${G(u,!1,!1,!0)[O]}`}let c="Indefinito";e.has("3maj")?c="Maggiore":e.has("3min")?c="Minore":e.has("3dim")||e.has("2")?c="Sus 2":(e.has("3aug")||e.has("4"))&&(c="Sus 4");let g="Omessa";e.has("5")?g="Giusta":e.has("5aug")?g="Aumentata":e.has("5dim")&&(g="Diminuita");let A="Triade";e.has("7maj")?A="Mag 7":e.has("7min")?A="Min 7":(e.has("7dim")||e.has("6"))&&(A="Sesta/Dim");const y=[];e.has("2min")&&y.push("b9"),e.has("2")&&!c.includes("Sus")&&y.push("9"),e.has("2aug")&&y.push("#9"),e.has("4")&&!c.includes("Sus")&&y.push("11"),e.has("4aug")&&y.push("#11"),e.has("6min")&&y.push("b13"),e.has("6")&&!A.includes("Sesta")&&y.push("13"),e.has("6aug")&&y.push("#13");const p={thirdQuality:c,fifthQuality:g,seventhQuality:A,extensions:y},j=G(u,!1,!1,!1)[0],M=n(f,E,d);i.push([I,d,f,E,Array.from(e),p,j,M])}i.sort((r,u)=>{const e=r[7],d=u[7];return e-d});let o=0;o=0;const l=i[o];return{root:l[0],base:l[1],quality:l[2],inversion:l[3],intervals:l[4],detailedAnalysis:l[5],rootName:l[6],options:i}}function J(h,a=!1){const t=tt(h,a),i=t.rootName,s=`${i}${t.base}${Array.isArray(t.quality)&&t.quality.length>0?t.quality.join(""):""}${t.inversion}`,n=t.options.map(o=>{const l=o[6],r=o[1],u=Array.isArray(o[2])?o[2]:[],e=u.length>0?u.join(""):"",d=o[3]||"";return{chordName:`${l}${r}${e}${d}`,root:o[0].normalizeToModulo(),components:{rootName:l,base:r,quality:u,inversion:d,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}});return{chordName:s,root:t.root.normalizeToModulo(),rootName:i,base:t.base,quality:t.quality,inversion:t.inversion,intervals:t.intervals,detailedAnalysis:t.detailedAnalysis,options:n}}function G(h,a=!0,t=!1,i=!0,s=!1){const l=a?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],r=new w([0,2,4,5,7,9,11],12,12),u=new C([2,2,1,2,2,2,1],12,0);let e=Y(r,h),d=e[0],f=e[1],E=Math.floor(f.data[0]/f.modulo)*f.modulo;const I=f.sum(-E);let c=0,g=I,A=0;if(s&&(A=H(J(g,!0).root,g).data[0],g=g.rototranslate(A)),d.element(c)<g.data[0])for(;d.element(c)<g.data[0];)c++;else for(;d.element(c)>=g.data[0];)c--;const y=g.degreeFunction();let p=y.degreeFunction.map(m=>m.degree);const j=y.intervalTypes,M=p.indexOf(6);M!==-1&&j.has("7dim")&&(p[M]=5);const O=p.indexOf(2);O!==-1&&j.has("3dim")&&(p[O]=1);const P=p.indexOf(2);P!==-1&&j.has("3aug")&&(p[P]=3);const R=p.indexOf(3);R!==-1&&(j.has("5dim")||j.has("4aug"))&&j.has("7min")&&(p[R]=4);let Q=[],b=p,D=1/0,T=c,U=1/0;for(let m=-1;m<=1;m++){let $=[],x=0,k=c+m;for(let B=0;B<g.data.length;B++){const st=Math.floor((g.data[B]-g.data[0])/g.modulo)*7,L=g.data[B]-d.element(p[B]+k+st);$[B]=L,[0,2,4].includes(p[B])?x+=2*L:[6].includes(p[B])&&(x+=L)}const S=Math.abs($[0]),W=S<U,et=S===U&&Math.abs(x)<Math.abs(D);(W||et)&&(D=x,Q=$,T=k,U=S)}let N=Q,F=b;if(c=T,i)for(let m=0;m<N.length;m++){const $=u.element(F[m]+c),x=u.element(F[m]+c-1);Math.abs(N[m])>=$&&Math.sign(N[m])==1?(N[m]-=u.element(F[m]+c),F[m]+=1):Math.abs(N[m])>=x&&Math.sign(N[m])==-1&&(N[m]+=u.element(F[m]+c-1),F[m]-=1)}let z=[];for(let m=0;m<F.length;m++){const $=v(m-A,N.length),x=N[$],k=l[v(F[$]+c,7)];if(t){const S=Math.round(x*50);S!==0?z[m]=`${k} ${S>0?"â†‘":"â†“"}${Math.abs(S)}Â¢`:z[m]=k}else{const S=Math.round(x);if(Math.abs(x)<1&&x!==0)z[m]=k+(x>0?"ð„²":"ð„³");else if(S!==0){const W=S>0?"â™¯":"â™­";z[m]=k+W.repeat(Math.min(Math.abs(S),2))}else z[m]=k}}return z}self.onmessage=h=>{const{activeNotes:a,selectedIndex:t,bassAsRoot:i,useEnharmonic:s}=h.data,n=new Set(a);if(n.size===0){self.postMessage({chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const o=Array.from(n).sort((d,f)=>d-f),l=new w(o,12,12).normalizeToModulo();let r=[];try{r=G(l,!0,!1,s,!1)}catch(d){console.error(d)}const u=new Map;o.forEach((d,f)=>{r[f]&&u.set(d,r[f])});let e=[];try{e=J(l,!i).options}catch(d){console.error(d)}if(e.length>0&&e[t]){const d=e[t],{root:f,components:E,detailedAnalysis:I}=d,c=H(f,l).data[0],g=l.rototranslate(c,l.data.length,!1),A=G(g,!0,!1,s,!1),y=(b,D)=>(b%D+D)%D;for(let b=0;b<A.length;b++){const D=y(g.data[b],12);o.forEach(T=>{y(T,12)===D&&A[b]&&u.set(T,A[b])})}const p=new Map,j=f.data[0],M=(b,D)=>{o.forEach(T=>{const U=y(T,12),N=y(U-j,12);b.includes(N)&&p.set(T,D)})};o.forEach(b=>p.set(b,"ext")),M([0],"root");const{thirdQuality:O,fifthQuality:P,seventhQuality:R}=I;O==="Maggiore"?M([4],"third"):O==="Minore"?M([3],"third"):O==="Sus 2"?M([2],"third"):O==="Sus 4"&&M([5],"third"),P==="Giusta"?M([7],"fifth"):P==="Aumentata"?M([8],"fifth"):P==="Diminuita"&&M([6],"fifth"),R==="Mag 7"?M([11],"seventh"):R==="Min 7"?M([10],"seventh"):R==="Sesta/Dim"&&M([9],"seventh");const Q=Array.from(p.values());self.postMessage({chordOptions:e,analysis:{rootName:E.rootName,quality:I.thirdQuality,stability:I.fifthQuality,function:I.seventhQuality,extensions:I.extensions,intervals:p,noteNames:u,flags:{isRootActive:Q.includes("root"),isThirdActive:Q.includes("third"),isFifthActive:Q.includes("fifth"),isSeventhActive:Q.includes("seventh")}}})}else{const d=new Map;o.forEach(f=>d.set(f,"active")),self.postMessage({chordOptions:e,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:d,noteNames:u,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}})}}})();
