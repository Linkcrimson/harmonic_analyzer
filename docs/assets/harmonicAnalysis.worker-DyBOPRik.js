(function(){"use strict";function w(h,e){if(e<0)return-w(-h,-e);let t=(h%e+e)%e;return t<0&&(t+=e),t}function B(h,e){return e===0?h:B(e,h%e)}function G(h,e){return h*e/B(h,e)}class E{constructor(e,t=12,i=0){this.data=e,this.modulo=t,this.offset=i}element(e){return this.data[w(e,this.data.length)]}rotate(e,t=this.data.length,i=!0){let a=new Array(t);for(let l=0;l<t;l++)a[l]=this.element(e+l);return i&&(this.data=a),new E(a,this.modulo,this.offset)}invert(e=!0){let t=this.data.length,i=new Array(t);for(let a=0;a<t;a++)i[a]=this.data[t-1-a];return e&&(this.data=i),new E(i,this.modulo,this.offset)}singleMirror(e,t,i=!0){let a=this.data,l=a.length;if(e=w(e,l),t)for(let u=0;u<e/2;++u){let o=a[u];a[u]=a[e-1-u],a[e-1-u]=o}else{let u=e+(l-e)/2;for(let o=e;o<u;++o){let m=a[o];a[o]=a[l-1-(o-e)],a[l-1-(o-e)]=m}}return i&&(this.data=a),new E(a,this.modulo,this.offset)}}class K{constructor(e,t=12,i=12){this.data=e,this.modulo=t,this.offset=i}}class j{constructor(e,t=12,i=12){this.data=e,this.modulo=t,this.span=i}element(e){let t=this.data.length,i=0;return i=e>=0?this.data[w(e,t)]+Math.abs(this.span)*~~(e/t):this.data[w(e,t)]+Math.abs(this.span)*(~~((e+1)/t)-1),i}rototranslate(e,t=this.data.length,i=!0){let a=new Array(t);for(let l=0;l<t;l++)a[l]=this.element(e+l);return i&&(this.data=a),new j(a,this.modulo,this.span)}spanUpdate(){let e=this.data[0],t=this.data[0],i=this.modulo;for(let l=0;l<this.data.length;l++)this.data[l]>e&&(e=this.data[l]),this.data[l]<t&&(t=this.data[l]);let a=e-t;if(i<=a)for(;i<=a;)i+=this.modulo;this.span=i}invert(e=!0){let t=this.data.slice();for(let i=0;i<t.length;i++)t[i]*=-1;return e&&(this.data=t),new j(t,this.modulo,this.span)}negative(e=10,t=!0,i=!0){let a=this.data.slice(),l=e;if(t){for(let o=0;o<a.length;o++)a[o]*=2;l=2*e-1}for(let o=0;o<a.length;o++)a[o]-=l;for(let o=0;o<a.length;o++)a[o]*=-1;for(let o=0;o<a.length;o++)a[o]+=l;if(t)for(let o=0;o<a.length;o++)a[o]/=2;a.sort(function(o,m){return o-m});let u=new j(a,this.modulo,this.span);return u.rototranslate(-1),i&&(this.data=a),u}options(e){let t=[],i=this.data.length;for(let a=e-i;a<e+i;a++){const l=this.rototranslate(a,i,!1);t.push(l)}return t}selectFromPosition(e){let t=[];for(let a=0;a<e.data.length;a++)t.push(this.element(e.data[a]));let i=new j(t,this.modulo,this.span);return i.spanUpdate(),i}freeInvert(e=1){if(this.data.length===0)return this;let t=new Array(this.data.length);switch(e){case 0:{const i=this.data[0];for(let a=0;a<this.data.length;a++)t[a]=2*i-this.data[a];break}case 2:{const i=this.data[this.data.length-1];for(let a=0;a<this.data.length;a++)t[a]=2*i-this.data[a];break}default:t=this.data.slice().reverse()}return new j(t,this.modulo,this.span)}sum(e=0){let t=[...this.data];for(let i=0;i<this.data.length;i++)t[i]+=e;return new j(t,this.modulo,this.span)}toZero(e=!1){let t=new j(this.data.slice(),this.modulo,this.span),i=t.data[0];for(let a=0;a<t.data.length;a++)t.data[a]=w(t.data[a]-i,t.modulo);return t.data.sort((a,l)=>a-l),t.spanUpdate(),e&&(this.data=t.data,this.span=t.span,this.modulo=t.modulo),t}isNote(e){for(let t=0;t<this.data.length;t++)if(w(this.data[t],this.modulo)===w(e,this.modulo))return!0;return!1}isAvoid(e){if(this.isNote(e))return!1;const t=this.modulo/2;for(let i=1;i<this.data.length;i++){const a=w(this.data[i],this.modulo);if(w(e-a,this.modulo)===t)return!0}return!1}degreeFunction(){let e=this.sum(-this.data[0]).normalizeToModulo(),t=e.data,i=e.toBinary().data,a=Array.from({length:this.data.length},(n,x)=>x);for(let n=1;n<t.length;n++)t[n]=w(Math.round(12*t[n]/this.modulo),12);let l=new Array(this.data.length),u=new Array(this.data.length);l[0]=0,u[0]="root";let o=new Set,m=new Set;m.add(0);for(const n of a.slice())t[n]==0&&(l[n]=0,u[n]="root",o.add("f"),a.splice(a.indexOf(n),1)),t[n]==4&&(l[n]=2,u[n]="3maj",m.add(4),o.add("3maj"),a.splice(a.indexOf(n),1)),t[n]==7&&(l[n]=4,u[n]="5",m.add(7),o.add("5"),a.splice(a.indexOf(n),1)),t[n]==11&&(l[n]=6,u[n]="7maj",m.add(11),o.add("7maj"),a.splice(a.indexOf(n),1));if(!o.has("3maj")&&i[3]==1){for(const n of a)if(t[n]==3){l[n]=2,u[n]="3min",m.add(3),o.add("3min"),a.splice(a.indexOf(n),1);break}}if(!o.has("5")&&!o.has("3min")&&i[8]==1){for(const n of a)if(t[n]==8){l[n]=4,u[n]="5aug",m.add(8),o.add("5aug"),a.splice(a.indexOf(n),1);break}}if(!o.has("3maj")&&!o.has("3min")&&i[2]==1){for(const n of a)if(t[n]==2){l[n]=2,u[n]="3dim",m.add(2),o.add("3dim"),a.splice(a.indexOf(n),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&i[5]==1){for(const n of a)if(t[n]==5){l[n]=2,u[n]="3aug",m.add(5),o.add("3aug"),a.splice(a.indexOf(n),1);break}}const c=i[10]==1;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||c)&&i[6]==1){for(const n of a)if(t[n]==6){l[n]=4,u[n]="5dim",m.add(6),o.add("5dim"),a.splice(a.indexOf(n),1);break}}if(!o.has("7maj")&&i[10]==1){for(const n of a)if(t[n]==10){l[n]=6,u[n]="7min",m.add(10),o.add("7min"),a.splice(a.indexOf(n),1);break}}if(!o.has("7maj")&&!o.has("7min")&&i[9]==1){for(const n of a)if(t[n]==9){l[n]=6,u[n]="7dim",m.add(9),o.add("7dim"),a.splice(a.indexOf(n),1);break}}for(const n of a)t[n]<4?(l[n]=1,t[n]==1?(o.add("2min"),u[n]="2min"):t[n]==2?(o.add("2"),u[n]="2"):t[n]==3&&(o.add("2aug"),u[n]="2aug")):t[n]>4&&t[n]<7?(l[n]=3,t[n]==5?(o.add("4"),u[n]="4"):t[n]==6&&(o.add("4aug"),u[n]="4aug")):t[n]>7&&t[n]<11&&(l[n]=5,t[n]==8?(o.add("6min"),u[n]="6min"):t[n]==9?(o.add("6"),u[n]="6"):t[n]==10&&(o.add("6aug"),u[n]="6aug"));return{degreeFunction:this.data.map((n,x)=>({degree:l[x],role:u[x]})),intervalTypes:o,baseChord:m}}isExtension(e){const{baseChord:t}=this.degreeFunction(),i=Math.round(12*w(e-this.data[0],this.modulo)/this.modulo);return!t.has(i)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((e,t)=>parseInt(e,10)-parseInt(t,10))}getDegrees(){return this.degreeFunction().degreeFunction.map(e=>e.degree)}normalizeToModulo(){const e=this.data.map(a=>w(a,this.modulo)),t=e[0],i=e.map(a=>a<t?a+this.modulo:a).sort((a,l)=>a-l);return new j(i,this.modulo,this.span)}toBinary(){let e=new K(new Array(this.span).fill(!1),this.modulo,this.data[0]),t=this.sum(-this.data[0]);for(const i of t.data){let a=w(i,this.span);e.data[a]=!0}return e}}function Z(h,e){if(h.modulo===e.modulo)return[h,e];let t=G(h.modulo,e.modulo),i=[];for(let l=0;l<h.data.length;l++)i.push(t/h.modulo*h.data[l]);let a=[];for(let l=0;l<e.data.length;l++)a.push(t/e.modulo*e.data[l]);return[new j(i,t,t/h.modulo*h.span),new j(a,t,t/e.modulo*e.span)]}function L(h,e){e.spanUpdate();let t=new j([],e.data.length,e.data.length),i=Math.floor(h.data[0]/h.modulo);if(e.element(i)>h.data[0])for(;e.element(i)>h.data[0];)i--;else if(e.element(i)<h.data[0]){for(;e.element(i)<h.data[0];)i++;i--}for(let a=0;a<h.data.length;a++){for(;e.element(i)<h.data[a];)i++;if(e.element(i)!=h.data[a])throw new Error("Error: Impossible finding element: "+h.data[a]+" nella scale."+e.data);t.data.push(i)}return t}function H(h){let e=h.data.length,t=new Array(e),i=h.offset;for(let a=0;a<e;a++)t[a]=i,i+=h.data[a];return i-=h.offset,new j(t,h.modulo,i)}const J={intervals:new E([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function X({intervals:h=new E([2,2,1,2,2,2,1],12,0),root:e=0,modo:t=0,grado:i=0,isInvert:a=!1,isMirror:l=!1,mirrorPos:u=0,mirrorLeft:o=!1}=J){h.offset=e;let m=h.rotate(t);a&&(m=m.invert()),l&&(m=m.singleMirror(u,o));let c=H(m);return c.spanUpdate(),c.rototranslate(i),c}X();function V(h,e=!1){const t=(function(o,m=!1){let c=o;c=c.sum(-o.data[0]);for(let f=1;f<c.data.length;f++)c.data[f]=w(c.data[f],c.modulo);c.data.sort((f,b)=>f-b),c.data=[...new Set(c.data)],c=c.sum(+o.data[0]);let n=[],x=1;m&&(x=c.data.length);const v=(f,b,s)=>{let d=0;return d+=f.length,b!==""&&(d+=2),(f.includes("b9")||f.includes("#9")||f.includes("b13"))&&(d+=2),s.includes("+")&&(d+=2),f.includes("omit3")&&(d+=3),f.includes("omit5")&&(d+=2),(f.includes("add9")||f.includes("addb9")||f.includes("add#9")||f.includes("add11")||f.includes("add#11")||f.includes("add13")||f.includes("addb13")||f.includes("add#13"))&&(d+=3),f.includes("#13")&&(d+=7),(f.includes("sus2")||f.includes("sus4"))&&(d+=2),d};for(let f=0;f<x;f++){let b=c.rototranslate(f,c.data.length,!1),s=new Set(b.getIntervalTypes()),d="",g=[],S="";s.has("5aug")&&(d="+"),s.has("3min")?d=s.has("5dim")?"dim":"-":!s.has("3maj")&&!s.has("3min")&&s.has("3dim")&&s.has("3aug")&&(d="5"),s.has("7maj")?s.has("2")?d+="maj9":d+="maj7":s.has("7min")?(d=="dim"&&(d="Ã¸"),s.has("2")?d+="9":d+="7"):s.has("7dim")&&(d+=d!="dim"?"6":"7"),s.has("4")&&s.has("3dim")?g.push("sus2/4"):s.has("3aug")?g.push("sus4"):s.has("3dim")&&g.push("sus2"),!s.has("5dim")||s.has("5")||s.has("5aug")||d.startsWith("dim")||d.startsWith("Ã¸")||g.push("b5"),s.has("2min")&&(s.has("7maj")||s.has("7min")?g.push("b9"):g.push("addb9")),s.has("2")&&(d.includes("9")||(s.has("7maj")||s.has("7min")?g.push("9"):g.push("add9"))),s.has("2aug")&&(s.has("7maj")||s.has("7min")?g.push("#9"):g.push("add#9")),s.has("4")&&!s.has("3dim")&&(!s.has("7maj")&&!s.has("7min")||s.has("3maj")?g.push("add11"):g.push("11")),s.has("4aug")&&!g.includes("b5")&&(s.has("7maj")||s.has("7min")||s.has("7dim")?g.push("#11"):g.push("add#11")),s.has("6min")&&(s.has("7maj")||s.has("7min")?g.push("b13"):g.push("addb13")),s.has("6")&&(s.has("7maj")||s.has("7min")?g.push("13"):g.push("add13")),s.has("6aug")&&g.push("#13"),s.has("3maj")||s.has("3min")||s.has("3aug")||s.has("3dim")||g.push("omit3"),s.has("5")||s.has("5dim")||s.has("5aug")||g.push("omit5");const z=new j([b.data[0]],o.modulo,o.span);if(m&&f!==0){const N=w(c.data.length-f,c.data.length);S=`/${C(b,!1,!1,!0)[N]}`}let $="Indefinito";s.has("3maj")?$="Maggiore":s.has("3min")?$="Minore":s.has("3dim")||s.has("2")?$="Sus 2":(s.has("3aug")||s.has("4"))&&($="Sus 4");let F="Omessa";s.has("5")?F="Giusta":s.has("5aug")?F="Aumentata":s.has("5dim")&&(F="Diminuita");let k="Triade";s.has("7maj")?k="Mag 7":s.has("7min")?k="Min 7":(s.has("7dim")||s.has("6"))&&(k="Sesta/Dim");const M=[];s.has("2min")&&M.push("b9"),s.has("2")&&!$.includes("Sus")&&M.push("9"),s.has("2aug")&&M.push("#9"),s.has("4")&&!$.includes("Sus")&&M.push("11"),s.has("4aug")&&M.push("#11"),s.has("6min")&&M.push("b13"),s.has("6")&&!k.includes("Sesta")&&M.push("13"),s.has("6aug")&&M.push("#13");const D={thirdQuality:$,fifthQuality:F,seventhQuality:k,extensions:M},Q=C(b,!1,!1,!1)[0],O=v(g,S,d);n.push([z,d,g,S,Array.from(s),D,Q,O,b])}n.sort((f,b)=>f[7]-b[7]);const y=n[0];return{root:y[0],base:y[1],quality:y[2],inversion:y[3],intervals:y[4],detailedAnalysis:y[5],rootName:y[6],options:n}})(h,e),i=t.rootName,a=`${i}${t.base}${Array.isArray(t.quality)&&t.quality.length>0?t.quality.join(""):""}${t.inversion}`,l=t.options.map(o=>{const m=o[6],c=o[1],n=Array.isArray(o[2])?o[2]:[],x=n.length>0?n.join(""):"",v=o[3]||"",y=o[8],f=y.degreeFunction().degreeFunction,b=new Map;return h.data.forEach(s=>{const d=w(s,12),g=y.data.findIndex(S=>w(S,12)===d);g!==-1&&b.set(s,f[g].role)}),{chordName:`${m}${c}${x}${v}`,root:o[0].normalizeToModulo(),noteRoles:b,components:{rootName:m,base:c,quality:n,inversion:v,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}}),u=l[0];return{chordName:a,root:t.root.normalizeToModulo(),rootName:i,base:t.base,quality:t.quality,inversion:t.inversion,intervals:t.intervals,detailedAnalysis:t.detailedAnalysis,noteRoles:u.noteRoles,options:l}}function C(h,e=!0,t=!1,i=!0,a=!1){const l=e?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],u=new j([0,2,4,5,7,9,11],12,12),o=new E([2,2,1,2,2,2,1],12,0);let m=Z(u,h),c=m[0],n=m[1],x=Math.floor(n.data[0]/n.modulo)*n.modulo,v=0,y=n.sum(-x),f=0;if(a&&(f=L(V(y,!0).root,y).data[0],y=y.rototranslate(f)),c.element(v)<y.data[0])for(;c.element(v)<y.data[0];)v++;else for(;c.element(v)>=y.data[0];)v--;const b=y.degreeFunction();let s=b.degreeFunction.map(r=>r.degree);const d=b.intervalTypes,g=s.indexOf(6);g!==-1&&d.has("7dim")&&(s[g]=5);const S=s.indexOf(2);S!==-1&&d.has("3dim")&&(s[S]=1);const z=s.indexOf(2);z!==-1&&d.has("3aug")&&(s[z]=3);const $=s.indexOf(3);$!==-1&&(d.has("5dim")||d.has("4aug"))&&d.has("7min")&&(s[$]=4);let F=[],k=s,M=1/0,D=v,Q=1/0;for(let r=-1;r<=1;r++){let A=[],p=0,R=v+r;for(let q=0;q<y.data.length;q++){const _=7*Math.floor((y.data[q]-y.data[0])/y.modulo),W=y.data[q]-c.element(s[q]+R+_);A[q]=W,[0,2,4].includes(s[q])?p+=2*W:[6].includes(s[q])&&(p+=W)}const T=Math.abs(A[0]),U=T<Q,Y=T===Q&&Math.abs(p)<Math.abs(M);(U||Y)&&(M=p,F=A,D=R,Q=T)}let O=F,N=k;if(v=D,i)for(let r=0;r<O.length;r++){const A=o.element(N[r]+v),p=o.element(N[r]+v-1);Math.abs(O[r])>=A&&Math.sign(O[r])==1?(O[r]-=o.element(N[r]+v),N[r]+=1):Math.abs(O[r])>=p&&Math.sign(O[r])==-1&&(O[r]+=o.element(N[r]+v-1),N[r]-=1)}let I=[];for(let r=0;r<N.length;r++){const A=w(r-f,O.length),p=O[A],R=l[w(N[A]+v,7)];if(t){const T=Math.round(50*p);I[r]=T!==0?`${R} ${T>0?"â†‘":"â†“"}${Math.abs(T)}Â¢`:R}else{const T=Math.round(p);if(Math.abs(p)<1&&p!==0)I[r]=R+(p>0?"ð„²":"ð„³");else if(T!==0){const U=T>0?"â™¯":"â™­";I[r]=R+U.repeat(Math.min(Math.abs(T),2))}else I[r]=R}}return I}const P=new Map;self.onmessage=h=>{var y,f,b;const{activeNotes:e,selectedIndex:t,bassAsRoot:i,useEnharmonic:a,requestId:l}=h.data,u=`${e.join(",")}|${t}|${i}|${a}`;if(P.has(u)){self.postMessage({...P.get(u),requestId:l});return}const o=new Set(e);if(o.size===0){self.postMessage({requestId:l,chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const m=Array.from(o).sort((s,d)=>s-d),c=new j(m,12,12).normalizeToModulo();let n=[];try{n=C(c,!0,!1,a,!1)}catch(s){console.error(s)}const x=new Map;m.forEach((s,d)=>{n[d]&&x.set(s,n[d])});let v=[];try{v=V(c,!i).options}catch(s){console.error(s)}if(v.length>0&&v[t]){const s=v[t],{root:d,components:g,detailedAnalysis:S}=s,z=L(d,c).data[0],$=c.rototranslate(z,c.data.length,!1),F=C($,!0,!1,a,!1),k=(r,A)=>(r%A+A)%A;for(let r=0;r<F.length;r++){const A=k($.data[r],12);m.forEach(p=>{k(p,12)===A&&F[r]&&x.set(p,F[r])})}const M=new Map;console.log("Worker Analysis Option:",s),console.log("Worker noteRoles:",s.noteRoles);const Q=Array.from(((y=s.noteRoles)==null?void 0:y.values())||[]).some(r=>["7maj","7min","7dim"].includes(r)),O=(f=s.detailedAnalysis)==null?void 0:f.thirdQuality;(b=s.noteRoles)==null||b.forEach((r,A)=>{console.log(`Mapping Note ${A} -> ${r}`);let p="ext";r==="root"?p="root":["3maj","3min","3dim","3aug"].includes(r)?p="third":r==="2"?O==="Sus 2"?p="third":p="9":r==="4"?O==="Sus 4"?p="third":p="11":["5","5dim","5aug"].includes(r)?p="fifth":["7maj","7min","7dim"].includes(r)?p="seventh":r==="6"?p=Q?"13":"seventh":r==="2min"?p="b9":r==="2aug"?p="#9":r==="4aug"?p="#11":r==="6min"?p="b13":r==="6aug"?p="#13":p=r,M.set(A,p)}),m.forEach(r=>{M.has(r)||M.set(r,"ext")});const N=Array.from(M.values()),I={chordOptions:v,analysis:{rootName:g.rootName,quality:S.thirdQuality,stability:S.fifthQuality,function:S.seventhQuality,extensions:S.extensions,intervals:Array.from(M),noteNames:Array.from(x),flags:{isRootActive:N.includes("root"),isThirdActive:N.includes("third"),isFifthActive:N.includes("fifth"),isSeventhActive:N.includes("seventh")}}};P.set(u,I),self.postMessage({...I,requestId:l})}else{const s=new Map;m.forEach(g=>s.set(g,"active"));const d={chordOptions:v,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:Array.from(s),noteNames:Array.from(x),flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}};P.set(u,d),self.postMessage({...d,requestId:l})}}})();
