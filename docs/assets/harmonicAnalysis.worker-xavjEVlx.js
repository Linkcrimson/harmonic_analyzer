(function(){"use strict";function b(u,s){if(s<0)return-b(-u,-s);let t=(u%s+s)%s;return t<0&&(t+=s),t}function G(u,s){return s===0?u:G(s,u%s)}function W(u,s){return u*s/G(u,s)}class P{constructor(s,t=12,e=0){this.data=s,this.modulo=t,this.offset=e}element(s){return this.data[b(s,this.data.length)]}rotate(s,t=this.data.length,e=!0){let a=new Array(t);for(let r=0;r<t;r++)a[r]=this.element(s+r);return e&&(this.data=a),new P(a,this.modulo,this.offset)}invert(s=!0){let t=this.data.length,e=new Array(t);for(let a=0;a<t;a++)e[a]=this.data[t-1-a];return s&&(this.data=e),new P(e,this.modulo,this.offset)}singleMirror(s,t,e=!0){let a=this.data,r=a.length;if(s=b(s,r),t)for(let o=0;o<s/2;++o){let d=a[o];a[o]=a[s-1-o],a[s-1-o]=d}else{let o=s+(r-s)/2;for(let d=s;d<o;++d){let f=a[d];a[d]=a[r-1-(d-s)],a[r-1-(d-s)]=f}}return e&&(this.data=a),new P(a,this.modulo,this.offset)}}class K{constructor(s,t=12,e=12){this.data=s,this.modulo=t,this.offset=e}}class x{constructor(s,t=12,e=12){this.data=s,this.modulo=t,this.span=e}element(s){let t=this.data.length,e=0;return e=s>=0?this.data[b(s,t)]+Math.abs(this.span)*~~(s/t):this.data[b(s,t)]+Math.abs(this.span)*(~~((s+1)/t)-1),e}rototranslate(s,t=this.data.length,e=!0){let a=new Array(t);for(let r=0;r<t;r++)a[r]=this.element(s+r);return e&&(this.data=a),new x(a,this.modulo,this.span)}spanUpdate(){let s=this.data[0],t=this.data[0],e=this.modulo;for(let r=0;r<this.data.length;r++)this.data[r]>s&&(s=this.data[r]),this.data[r]<t&&(t=this.data[r]);let a=s-t;if(e<=a)for(;e<=a;)e+=this.modulo;this.span=e}invert(s=!0){let t=this.data.slice();for(let e=0;e<t.length;e++)t[e]*=-1;return s&&(this.data=t),new x(t,this.modulo,this.span)}negative(s=10,t=!0,e=!0){let a=this.data.slice(),r=s;if(t){for(let d=0;d<a.length;d++)a[d]*=2;r=2*s-1}for(let d=0;d<a.length;d++)a[d]-=r;for(let d=0;d<a.length;d++)a[d]*=-1;for(let d=0;d<a.length;d++)a[d]+=r;if(t)for(let d=0;d<a.length;d++)a[d]/=2;a.sort(function(d,f){return d-f});let o=new x(a,this.modulo,this.span);return o.rototranslate(-1),e&&(this.data=a),o}options(s){let t=[],e=this.data.length;for(let a=s-e;a<s+e;a++){const r=this.rototranslate(a,e,!1);t.push(r)}return t}selectFromPosition(s){let t=[];for(let a=0;a<s.data.length;a++)t.push(this.element(s.data[a]));let e=new x(t,this.modulo,this.span);return e.spanUpdate(),e}freeInvert(s=1){if(this.data.length===0)return this;let t=new Array(this.data.length);switch(s){case 0:{const e=this.data[0];for(let a=0;a<this.data.length;a++)t[a]=2*e-this.data[a];break}case 2:{const e=this.data[this.data.length-1];for(let a=0;a<this.data.length;a++)t[a]=2*e-this.data[a];break}default:t=this.data.slice().reverse()}return new x(t,this.modulo,this.span)}sum(s=0){let t=[...this.data];for(let e=0;e<this.data.length;e++)t[e]+=s;return new x(t,this.modulo,this.span)}toZero(s=!1){let t=new x(this.data.slice(),this.modulo,this.span),e=t.data[0];for(let a=0;a<t.data.length;a++)t.data[a]=b(t.data[a]-e,t.modulo);return t.data.sort((a,r)=>a-r),t.spanUpdate(),s&&(this.data=t.data,this.span=t.span,this.modulo=t.modulo),t}isNote(s){for(let t=0;t<this.data.length;t++)if(b(this.data[t],this.modulo)===b(s,this.modulo))return!0;return!1}isAvoid(s){if(this.isNote(s))return!1;const t=this.modulo/2;for(let e=1;e<this.data.length;e++){const a=b(this.data[e],this.modulo);if(b(s-a,this.modulo)===t)return!0}return!1}degreeFunction(){let s=this.sum(-this.data[0]).normalizeToModulo(),t=s.data,e=s.toBinary().data,a=Array.from({length:this.data.length},(n,A)=>A);for(let n=1;n<t.length;n++)t[n]=b(Math.round(12*t[n]/this.modulo),12);let r=new Array(this.data.length);r[0]=0;let o=new Set,d=new Set;d.add(0);for(const n of a.slice())t[n]==0&&(r[n]=0,o.add("f"),a.splice(a.indexOf(n),1)),t[n]==4&&(r[n]=2,d.add(4),o.add("3maj"),a.splice(a.indexOf(n),1)),t[n]==7&&(r[n]=4,d.add(7),o.add("5"),a.splice(a.indexOf(n),1)),t[n]==11&&(r[n]=6,d.add(11),o.add("7maj"),a.splice(a.indexOf(n),1));if(!o.has("3maj")&&e[3]==1){for(const n of a)if(t[n]==3){r[n]=2,d.add(3),o.add("3min"),a.splice(a.indexOf(n),1);break}}if(!o.has("5")&&!o.has("3min")&&e[8]==1){for(const n of a)if(t[n]==8){r[n]=4,d.add(8),o.add("5aug"),a.splice(a.indexOf(n),1);break}}if(!o.has("3maj")&&!o.has("3min")&&e[2]==1){for(const n of a)if(t[n]==2){r[n]=2,d.add(2),o.add("3dim"),a.splice(a.indexOf(n),1);break}}if(!o.has("3maj")&&!o.has("3min")&&!o.has("3dim")&&e[5]==1){for(const n of a)if(t[n]==5){r[n]=2,d.add(5),o.add("3aug"),a.splice(a.indexOf(n),1);break}}const f=e[10]==1;if(!o.has("5")&&!o.has("5aug")&&(!o.has("3maj")||f)&&e[6]==1){for(const n of a)if(t[n]==6){r[n]=4,d.add(6),o.add("5dim"),a.splice(a.indexOf(n),1);break}}if(!o.has("7maj")&&e[10]==1){for(const n of a)if(t[n]==10){r[n]=6,d.add(10),o.add("7min"),a.splice(a.indexOf(n),1);break}}if(!o.has("7maj")&&!o.has("7min")&&e[9]==1){for(const n of a)if(t[n]==9){r[n]=6,d.add(9),o.add("7dim"),a.splice(a.indexOf(n),1);break}}for(const n of a)t[n]<4?(r[n]=1,t[n]==1?o.add("2min"):t[n]==2?o.add("2"):t[n]==3&&o.add("2aug")):t[n]>4&&t[n]<7?(r[n]=3,t[n]==5?o.add("4"):t[n]==6&&o.add("4aug")):t[n]>7&&t[n]<11&&(r[n]=5,t[n]==8?o.add("6min"):t[n]==9?o.add("6"):t[n]==10&&o.add("6aug"));return{degreeFunction:this.data.map((n,A)=>({degree:r[A]})),intervalTypes:o,baseChord:d}}isExtension(s){const{baseChord:t}=this.degreeFunction(),e=Math.round(12*b(s-this.data[0],this.modulo)/this.modulo);return!t.has(e)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((s,t)=>parseInt(s,10)-parseInt(t,10))}getDegrees(){return this.degreeFunction().degreeFunction.map(s=>s.degree)}normalizeToModulo(){const s=this.data.map(a=>b(a,this.modulo)),t=s[0],e=s.map(a=>a<t?a+this.modulo:a).sort((a,r)=>a-r);return new x(e,this.modulo,this.span)}toBinary(){let s=new K(new Array(this.span).fill(!1),this.modulo,this.data[0]),t=this.sum(-this.data[0]);for(const e of t.data){let a=b(e,this.span);s.data[a]=!0}return s}}function Z(u,s){if(u.modulo===s.modulo)return[u,s];let t=W(u.modulo,s.modulo),e=[];for(let r=0;r<u.data.length;r++)e.push(t/u.modulo*u.data[r]);let a=[];for(let r=0;r<s.data.length;r++)a.push(t/s.modulo*s.data[r]);return[new x(e,t,t/u.modulo*u.span),new x(a,t,t/s.modulo*s.span)]}function L(u,s){s.spanUpdate();let t=new x([],s.data.length,s.data.length),e=Math.floor(u.data[0]/u.modulo);if(s.element(e)>u.data[0])for(;s.element(e)>u.data[0];)e--;else if(s.element(e)<u.data[0]){for(;s.element(e)<u.data[0];)e++;e--}for(let a=0;a<u.data.length;a++){for(;s.element(e)<u.data[a];)e++;if(s.element(e)!=u.data[a])throw new Error("Error: Impossible finding element: "+u.data[a]+" nella scale."+s.data);t.data.push(e)}return t}function H(u){let s=u.data.length,t=new Array(s),e=u.offset;for(let a=0;a<s;a++)t[a]=e,e+=u.data[a];return e-=u.offset,new x(t,u.modulo,e)}const J={intervals:new P([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function X({intervals:u=new P([2,2,1,2,2,2,1],12,0),root:s=0,modo:t=0,grado:e=0,isInvert:a=!1,isMirror:r=!1,mirrorPos:o=0,mirrorLeft:d=!1}=J){u.offset=s;let f=u.rotate(t);a&&(f=f.invert()),r&&(f=f.singleMirror(o,d));let n=H(f);return n.spanUpdate(),n.rototranslate(e),n}X();function V(u,s=!1){const t=(function(o,d=!1){let f=o;f=f.sum(-o.data[0]);for(let l=1;l<f.data.length;l++)f.data[l]=b(f.data[l],f.modulo);f.data.sort((l,g)=>l-g),f.data=[...new Set(f.data)],f=f.sum(+o.data[0]);let n=[],A=1;d&&(A=f.data.length);const F=(l,g,i)=>{let h=0;return h+=l.length,g!==""&&(h+=2),(l.includes("b9")||l.includes("#9")||l.includes("b13"))&&(h+=2),i.includes("+")&&(h+=2),l.includes("omit3")&&(h+=3),l.includes("omit5")&&(h+=2),(l.includes("add9")||l.includes("addb9")||l.includes("add#9")||l.includes("add11")||l.includes("add#11")||l.includes("add13")||l.includes("addb13")||l.includes("add#13"))&&(h+=3),l.includes("#13")&&(h+=7),(l.includes("sus2")||l.includes("sus4"))&&(h+=2),h};for(let l=0;l<A;l++){let g=f.rototranslate(l,f.data.length,!1),i=new Set(g.getIntervalTypes()),h="",c=[],k="";i.has("5aug")&&(h="+"),i.has("3min")?h=i.has("5dim")?"dim":"-":!i.has("3maj")&&!i.has("3min")&&i.has("3dim")&&i.has("3aug")&&(h="5"),i.has("7maj")?i.has("2")?h+="maj9":h+="maj7":i.has("7min")?(h=="dim"&&(h="Ã¸"),i.has("2")?h+="9":h+="7"):i.has("7dim")&&(h+=h!="dim"?"6":"7"),i.has("4")&&i.has("3dim")?c.push("sus2/4"):i.has("3aug")?c.push("sus4"):i.has("3dim")&&c.push("sus2"),!i.has("5dim")||i.has("5")||i.has("5aug")||h.startsWith("dim")||h.startsWith("Ã¸")||c.push("b5"),i.has("2min")&&(i.has("7maj")||i.has("7min")?c.push("b9"):c.push("addb9")),i.has("2")&&(h.includes("9")||(i.has("7maj")||i.has("7min")?c.push("9"):c.push("add9"))),i.has("2aug")&&(i.has("7maj")||i.has("7min")?c.push("#9"):c.push("add#9")),i.has("4")&&!i.has("3dim")&&(!i.has("7maj")&&!i.has("7min")||i.has("3maj")?c.push("add11"):c.push("11")),i.has("4aug")&&!c.includes("b5")&&(i.has("7maj")||i.has("7min")||i.has("7dim")?c.push("#11"):c.push("add#11")),i.has("6min")&&(i.has("7maj")||i.has("7min")?c.push("b13"):c.push("addb13")),i.has("6")&&(i.has("7maj")||i.has("7min")?c.push("13"):c.push("add13")),i.has("6aug")&&c.push("#13"),i.has("3maj")||i.has("3min")||i.has("3aug")||i.has("3dim")||c.push("omit3"),i.has("5")||i.has("5dim")||i.has("5aug")||c.push("omit5");const I=new x([g.data[0]],o.modulo,o.span);if(d&&l!==0){const M=b(f.data.length-l,f.data.length);k=`/${z(g,!1,!1,!0)[M]}`}let j="Indefinito";i.has("3maj")?j="Maggiore":i.has("3min")?j="Minore":i.has("3dim")||i.has("2")?j="Sus 2":(i.has("3aug")||i.has("4"))&&(j="Sus 4");let O="Omessa";i.has("5")?O="Giusta":i.has("5aug")?O="Aumentata":i.has("5dim")&&(O="Diminuita");let T="Triade";i.has("7maj")?T="Mag 7":i.has("7min")?T="Min 7":(i.has("7dim")||i.has("6"))&&(T="Sesta/Dim");const y=[];i.has("2min")&&y.push("b9"),i.has("2")&&!j.includes("Sus")&&y.push("9"),i.has("2aug")&&y.push("#9"),i.has("4")&&!j.includes("Sus")&&y.push("11"),i.has("4aug")&&y.push("#11"),i.has("6min")&&y.push("b13"),i.has("6")&&!T.includes("Sesta")&&y.push("13"),i.has("6aug")&&y.push("#13");const q={thirdQuality:j,fifthQuality:O,seventhQuality:T,extensions:y},Q=z(g,!1,!1,!1)[0],E=F(c,k,h);n.push([I,h,c,k,Array.from(i),q,Q,E])}n.sort((l,g)=>l[7]-g[7]);const p=n[0];return{root:p[0],base:p[1],quality:p[2],inversion:p[3],intervals:p[4],detailedAnalysis:p[5],rootName:p[6],options:n}})(u,s),e=t.rootName,a=`${e}${t.base}${Array.isArray(t.quality)&&t.quality.length>0?t.quality.join(""):""}${t.inversion}`,r=t.options.map(o=>{const d=o[6],f=o[1],n=Array.isArray(o[2])?o[2]:[],A=n.length>0?n.join(""):"",F=o[3]||"";return{chordName:`${d}${f}${A}${F}`,root:o[0].normalizeToModulo(),components:{rootName:d,base:f,quality:n,inversion:F,intervals:o[4],detailedAnalysis:o[5]},intervals:o[4],detailedAnalysis:o[5],score:o[7]}});return{chordName:a,root:t.root.normalizeToModulo(),rootName:e,base:t.base,quality:t.quality,inversion:t.inversion,intervals:t.intervals,detailedAnalysis:t.detailedAnalysis,options:r}}function z(u,s=!0,t=!1,e=!0,a=!1){const r=s?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],o=new x([0,2,4,5,7,9,11],12,12),d=new P([2,2,1,2,2,2,1],12,0);let f=Z(o,u),n=f[0],A=f[1],F=Math.floor(A.data[0]/A.modulo)*A.modulo,p=0,l=A.sum(-F),g=0;if(a&&(g=L(V(l,!0).root,l).data[0],l=l.rototranslate(g)),n.element(p)<l.data[0])for(;n.element(p)<l.data[0];)p++;else for(;n.element(p)>=l.data[0];)p--;const i=l.degreeFunction();let h=i.degreeFunction.map(m=>m.degree);const c=i.intervalTypes,k=h.indexOf(6);k!==-1&&c.has("7dim")&&(h[k]=5);const I=h.indexOf(2);I!==-1&&c.has("3dim")&&(h[I]=1);const j=h.indexOf(2);j!==-1&&c.has("3aug")&&(h[j]=3);const O=h.indexOf(3);O!==-1&&(c.has("5dim")||c.has("4aug"))&&c.has("7min")&&(h[O]=4);let T=[],y=h,q=1/0,Q=p,E=1/0;for(let m=-1;m<=1;m++){let w=[],v=0,$=p+m;for(let D=0;D<l.data.length;D++){const _=7*Math.floor((l.data[D]-l.data[0])/l.modulo),B=l.data[D]-n.element(h[D]+$+_);w[D]=B,[0,2,4].includes(h[D])?v+=2*B:[6].includes(h[D])&&(v+=B)}const N=Math.abs(w[0]),U=N<E,Y=N===E&&Math.abs(v)<Math.abs(q);(U||Y)&&(q=v,T=w,Q=$,E=N)}let M=T,S=y;if(p=Q,e)for(let m=0;m<M.length;m++){const w=d.element(S[m]+p),v=d.element(S[m]+p-1);Math.abs(M[m])>=w&&Math.sign(M[m])==1?(M[m]-=d.element(S[m]+p),S[m]+=1):Math.abs(M[m])>=v&&Math.sign(M[m])==-1&&(M[m]+=d.element(S[m]+p-1),S[m]-=1)}let C=[];for(let m=0;m<S.length;m++){const w=b(m-g,M.length),v=M[w],$=r[b(S[w]+p,7)];if(t){const N=Math.round(50*v);C[m]=N!==0?`${$} ${N>0?"â†‘":"â†“"}${Math.abs(N)}Â¢`:$}else{const N=Math.round(v);if(Math.abs(v)<1&&v!==0)C[m]=$+(v>0?"ð„²":"ð„³");else if(N!==0){const U=N>0?"â™¯":"â™­";C[m]=$+U.repeat(Math.min(Math.abs(N),2))}else C[m]=$}}return C}const R=new Map;self.onmessage=u=>{const{activeNotes:s,selectedIndex:t,bassAsRoot:e,useEnharmonic:a,requestId:r}=u.data,o=`${s.join(",")}|${t}|${e}|${a}`;if(R.has(o)){self.postMessage({...R.get(o),requestId:r});return}const d=new Set(s);if(d.size===0){self.postMessage({requestId:r,chordOptions:[],analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:new Map,noteNames:new Map,flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}});return}const f=Array.from(d).sort((l,g)=>l-g),n=new x(f,12,12).normalizeToModulo();let A=[];try{A=z(n,!0,!1,a,!1)}catch(l){console.error(l)}const F=new Map;f.forEach((l,g)=>{A[g]&&F.set(l,A[g])});let p=[];try{p=V(n,!e).options}catch(l){console.error(l)}if(p.length>0&&p[t]){const l=p[t],{root:g,components:i,detailedAnalysis:h}=l,c=L(g,n).data[0],k=n.rototranslate(c,n.data.length,!1),I=z(k,!0,!1,a,!1),j=(m,w)=>(m%w+w)%w;for(let m=0;m<I.length;m++){const w=j(k.data[m],12);f.forEach(v=>{j(v,12)===w&&I[m]&&F.set(v,I[m])})}const O=new Map,T=g.data[0],y=(m,w)=>{f.forEach(v=>{const $=j(v,12),N=j($-T,12);m.includes(N)&&O.set(v,w)})};f.forEach(m=>O.set(m,"ext")),y([0],"root");const{thirdQuality:q,fifthQuality:Q,seventhQuality:E}=h;q==="Maggiore"?y([4],"third"):q==="Minore"?y([3],"third"):q==="Sus 2"?y([2],"third"):q==="Sus 4"&&y([5],"third"),Q==="Giusta"?y([7],"fifth"):Q==="Aumentata"?y([8],"fifth"):Q==="Diminuita"&&y([6],"fifth"),E==="Mag 7"?y([11],"seventh"):E==="Min 7"?y([10],"seventh"):E==="Sesta/Dim"&&y([9],"seventh");const M=(m,w)=>{f.forEach(v=>{const $=j(v,12),N=j($-T,12);m.includes(N)&&O.get(v)==="ext"&&O.set(v,w)})};M([1],"b9"),M([2],"9"),M([3],"#9"),M([5],"11"),M([6],"#11"),M([8],"b13"),M([9],"13"),M([10],"#13");const S=Array.from(O.values()),C={chordOptions:p,analysis:{rootName:i.rootName,quality:h.thirdQuality,stability:h.fifthQuality,function:h.seventhQuality,extensions:h.extensions,intervals:Array.from(O),noteNames:Array.from(F),flags:{isRootActive:S.includes("root"),isThirdActive:S.includes("third"),isFifthActive:S.includes("fifth"),isSeventhActive:S.includes("seventh")}}};R.set(o,C),self.postMessage({...C,requestId:r})}else{const l=new Map;f.forEach(i=>l.set(i,"active"));const g={chordOptions:p,analysis:{rootName:"--",quality:"--",stability:"--",function:"--",extensions:[],intervals:Array.from(l),noteNames:Array.from(F),flags:{isRootActive:!1,isThirdActive:!1,isFifthActive:!1,isSeventhActive:!1}}};R.set(o,g),self.postMessage({...g,requestId:r})}}})();
