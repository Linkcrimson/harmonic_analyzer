<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analizzatore Armonico</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();function C(l,t){if(t<0)return-C(-l,-t);let e=(l%t+t)%t;return e<0&&(e+=t),e}function de(l,t){return t===0?l:de(t,l%t)}function pe(l,t){return l*t/de(l,t)}class ge{constructor(t,e=12,a=12){this.data=t,this.modulo=e,this.offset=a}}class I{constructor(t,e=12,a=12){this.data=t,this.modulo=e,this.span=a}element(t){let e=this.data.length,a=0;return t>=0?a=this.data[C(t,e)]+Math.abs(this.span)*~~(t/e):a=this.data[C(t,e)]+Math.abs(this.span)*(~~((t+1)/e)-1),a}rototranslate(t,e=this.data.length,a=!0){let n=new Array(e);for(let i=0;i<e;i++)n[i]=this.element(t+i);return a&&(this.data=n),new I(n,this.modulo,this.span)}spanUpdate(){let t=this.data[0],e=this.data[0],a=this.modulo;for(let i=0;i<this.data.length;i++)this.data[i]>t&&(t=this.data[i]),this.data[i]<e&&(e=this.data[i]);let n=t-e;if(a<=n)for(;a<=n;)a+=this.modulo;this.span=a}invert(t=!0){let e=this.data.slice();for(let a=0;a<e.length;a++)e[a]*=-1;return t&&(this.data=e),new I(e,this.modulo,this.span)}negative(t=10,e=!0,a=!0){let n=this.data.slice(),i=t;if(e){for(let d=0;d<n.length;d++)n[d]*=2;i=t*2-1}for(let d=0;d<n.length;d++)n[d]-=i;for(let d=0;d<n.length;d++)n[d]*=-1;for(let d=0;d<n.length;d++)n[d]+=i;if(e)for(let d=0;d<n.length;d++)n[d]/=2;n.sort(function(d,c){return d-c});let r=new I(n,this.modulo,this.span);return r.rototranslate(-1),a&&(this.data=n),r}options(t){let e=[],a=this.data.length;for(let n=t-a;n<t+a;n++){const i=this.rototranslate(n,a,!1);e.push(i)}return e}selectFromPosition(t){let e=[];for(let n=0;n<t.data.length;n++)e.push(this.element(t.data[n]));let a=new I(e,this.modulo,this.span);return a.spanUpdate(),a}freeInvert(t=1){if(this.data.length===0)return this;let e=new Array(this.data.length);switch(t){case 0:{const a=this.data[0];for(let n=0;n<this.data.length;n++)e[n]=2*a-this.data[n];break}case 2:{const a=this.data[this.data.length-1];for(let n=0;n<this.data.length;n++)e[n]=2*a-this.data[n];break}case 1:default:e=this.data.slice().reverse();break}return new I(e,this.modulo,this.span)}sum(t=0){let e=[...this.data];for(let a=0;a<this.data.length;a++)e[a]+=t;return new I(e,this.modulo,this.span)}toZero(t=!1){let e=new I(this.data.slice(),this.modulo,this.span),a=e.data[0];for(let n=0;n<e.data.length;n++)e.data[n]=C(e.data[n]-a,e.modulo);return e.data.sort((n,i)=>n-i),e.spanUpdate(),t&&(this.data=e.data,this.span=e.span,this.modulo=e.modulo),e}isNote(t){for(let e=0;e<this.data.length;e++)if(C(this.data[e],this.modulo)===C(t,this.modulo))return!0;return!1}isAvoid(t){if(this.isNote(t))return!1;const e=this.modulo/2;for(let a=1;a<this.data.length;a++){const n=C(this.data[a],this.modulo);if(C(t-n,this.modulo)===e)return!0}return!1}degreeFunction(){let t=this.sum(-this.data[0]).normalizeToModulo(),e=t.data,a=t.toBinary().data,n=Array.from({length:this.data.length},(s,o)=>o);for(let s=1;s<e.length;s++)e[s]=C(Math.round(e[s]*12/this.modulo),12);let i=new Array(this.data.length);i[0]=0;let r=new Set,d=new Set;d.add(0);for(const s of n.slice())e[s]==0&&(i[s]=0,r.add("f"),n.splice(n.indexOf(s),1)),e[s]==4&&(i[s]=2,d.add(4),r.add("3maj"),n.splice(n.indexOf(s),1)),e[s]==7&&(i[s]=4,d.add(7),r.add("5"),n.splice(n.indexOf(s),1)),e[s]==11&&(i[s]=6,d.add(11),r.add("7maj"),n.splice(n.indexOf(s),1));if(!r.has("3maj")&&a[3]==!0){for(const s of n)if(e[s]==3){i[s]=2,d.add(3),r.add("3min"),n.splice(n.indexOf(s),1);break}}if(!r.has("5")&&!r.has("3min")&&a[8]==!0){for(const s of n)if(e[s]==8){i[s]=4,d.add(8),r.add("5aug"),n.splice(n.indexOf(s),1);break}}if(!r.has("3maj")&&!r.has("3min")&&a[2]==!0){for(const s of n)if(e[s]==2){i[s]=2,d.add(2),r.add("3dim"),n.splice(n.indexOf(s),1);break}}if(!r.has("3maj")&&!r.has("3min")&&!r.has("3dim")&&a[5]==!0){for(const s of n)if(e[s]==5){i[s]=2,d.add(5),r.add("3aug"),n.splice(n.indexOf(s),1);break}}if(!r.has("5")&&!r.has("5aug")&&!r.has("3maj")&&a[6]==!0){for(const s of n)if(e[s]==6){i[s]=4,d.add(6),r.add("5dim"),n.splice(n.indexOf(s),1);break}}if(!r.has("7maj")&&a[10]==!0){for(const s of n)if(e[s]==10){i[s]=6,d.add(10),r.add("7min"),n.splice(n.indexOf(s),1);break}}if(!r.has("7maj")&&!r.has("7min")&&a[9]==!0){for(const s of n)if(e[s]==9){i[s]=6,d.add(9),r.add("7dim"),n.splice(n.indexOf(s),1);break}}for(const s of n)e[s]<4?(i[s]=1,e[s]==1?r.add("2min"):e[s]==2?r.add("2"):e[s]==3&&r.add("2aug")):e[s]>4&&e[s]<7?(i[s]=3,e[s]==5?r.add("4"):e[s]==6&&r.add("4aug")):e[s]>7&&e[s]<11&&(i[s]=5,e[s]==8?r.add("6min"):e[s]==9&&r.add("6"));return{degreeFunction:this.data.map((s,o)=>({degree:i[o]})),intervalTypes:r,baseChord:d}}isExtension(t){const{baseChord:e}=this.degreeFunction(),a=Math.round(C(t-this.data[0],this.modulo)*12/this.modulo);return!e.has(a)}getIntervalTypes(){return Array.from(this.degreeFunction().intervalTypes).sort((e,a)=>{const n=parseInt(e,10),i=parseInt(a,10);return n-i})}getDegrees(){return this.degreeFunction().degreeFunction.map(t=>t.degree)}normalizeToModulo(){const t=this.data.map(i=>C(i,this.modulo)),e=t[0],n=t.map(i=>i<e?i+this.modulo:i).sort((i,r)=>i-r);return new I(n,this.modulo,this.span)}toBinary(){let t=new ge(new Array(this.span).fill(!1),this.modulo,this.data[0]),e=this.sum(-this.data[0]);for(const a of e.data){let n=C(a,this.span);t.data[n]=!0}return t}}function ye(l,t){if(l.modulo===t.modulo)return[l,t];let e=pe(l.modulo,t.modulo),a=[];for(let i=0;i<l.data.length;i++)a.push(e/l.modulo*l.data[i]);let n=[];for(let i=0;i<t.data.length;i++)n.push(e/t.modulo*t.data[i]);return[new I(a,e,e/l.modulo*l.span),new I(n,e,e/t.modulo*t.span)]}function ce(l,t){t.spanUpdate();let e=new I([],t.data.length,t.data.length),a=Math.floor(l.data[0]/l.modulo);if(t.element(a)>l.data[0])for(;t.element(a)>l.data[0];)a--;else if(t.element(a)<l.data[0]){for(;t.element(a)<l.data[0];)a++;a--}for(let n=0;n<l.data.length;n++){for(;t.element(a)<l.data[n];)a++;if(t.element(a)==l.data[n])e.data.push(a);else throw new Error("Error: Impossible finding element: "+l.data[n]+" nella scale."+t.data)}return e}class Q{constructor(t,e=12,a=0){this.data=t,this.modulo=e,this.offset=a}element(t){return this.data[C(t,this.data.length)]}rotate(t,e=this.data.length,a=!0){let n=new Array(e);for(let i=0;i<e;i++)n[i]=this.element(t+i);return a&&(this.data=n),new Q(n,this.modulo,this.offset)}invert(t=!0){let e=this.data.length,a=new Array(e);for(let n=0;n<e;n++)a[n]=this.data[e-1-n];return t&&(this.data=a),new Q(a,this.modulo,this.offset)}singleMirror(t,e,a=!0){let n=this.data,i=n.length;if(t=C(t,i),e)for(let r=0;r<t/2;++r){let d=n[r];n[r]=n[t-1-r],n[t-1-r]=d}else{let r=t+(i-t)/2;for(let d=t;d<r;++d){let c=n[d];n[d]=n[i-1-(d-t)],n[i-1-(d-t)]=c}}return a&&(this.data=n),new Q(n,this.modulo,this.offset)}}const xe={intervals:new Q([2,2,1,2,2,2,1],12,0),root:0,modo:0,grado:0,isInvert:!1,isMirror:!1,mirrorPos:0,mirrorLeft:!1};function ve({intervals:l=new Q([2,2,1,2,2,2,1],12,0),root:t=0,modo:e=0,grado:a=0,isInvert:n=!1,isMirror:i=!1,mirrorPos:r=0,mirrorLeft:d=!1}=xe){l.offset=t;let c=l.rotate(e);n&&(c=c.invert()),i&&(c=c.singleMirror(r,d));let s=be(c);return s.spanUpdate(),s.rototranslate(a),s}function be(l){let t=l.data.length,e=new Array(t),a=l.offset;for(let n=0;n<t;n++)e[n]=a,a+=l.data[n];return a-=l.offset,new I(e,l.modulo,a)}ve();function Ce(l,t=!1){let e=l;e=e.sum(-l.data[0]);for(let c=1;c<e.data.length;c++)e.data[c]=C(e.data[c],e.modulo);e.data.sort((c,s)=>c-s),e.data=[...new Set(e.data)],e=e.sum(+l.data[0]);let a=[],n=1;t&&(n=e.data.length);for(let c=0;c<n;c++){let s=e.rototranslate(c,e.data.length,!1),o=new Set(s.getIntervalTypes()),m="",h=[],v="";o.has("5aug")&&(m="+"),o.has("3min")?o.has("5dim")?m="dim":m="-":!o.has("3maj")&&!o.has("3min")&&o.has("3dim")&&o.has("3aug")&&(m="5"),o.has("7maj")?o.has("2")?m+="maj9":m+="maj7":o.has("7min")?(m=="dim"&&(m="Ã¸"),o.has("2")?m+="9":m+="7"):o.has("7dim")&&(m!="dim"?m+="6":m+="7"),o.has("4")&&o.has("3dim")?h.push("sus2/4"):o.has("3aug")?h.push("sus4"):o.has("3dim")&&h.push("sus2"),(o.has("3aug")||o.has("3dim")||o.has("4")&&o.has("3dim"))&&o.has("5dim")&&!o.has("5")&&!o.has("5aug")&&h.push("â™­5"),o.has("2min")&&(!o.has("7maj")&&!o.has("7min")?h.push("addâ™­9"):h.push("â™­9")),o.has("2")&&(m.includes("9")||(!o.has("7maj")&&!o.has("7min")?h.push("add9"):h.push("9"))),o.has("2aug")&&(!o.has("7maj")&&!o.has("7min")?h.push("addâ™¯9"):h.push("â™¯9")),o.has("4")&&!o.has("3dim")&&(!o.has("7maj")&&!o.has("7min")||o.has("3maj")?h.push("add11"):h.push("11")),o.has("4aug")&&(!o.has("7maj")&&!o.has("7min")&&!o.has("7dim")?h.push("addâ™¯11"):h.push("â™¯11")),o.has("6min")&&(!o.has("7maj")&&!o.has("7min")?h.push("addâ™­13"):h.push("â™­13")),o.has("6")&&(!o.has("7maj")&&!o.has("7min")?h.push("add13"):h.push("13")),o.has("6aug")&&h.push("â™¯13"),!o.has("3maj")&&!o.has("3min")&&!o.has("3aug")&&!o.has("3dim")&&h.push("omit3"),!o.has("5")&&!o.has("5dim")&&!o.has("5aug")&&h.push("omit5");const L=new I([s.data[0]],l.modulo,l.span);if(t&&c!==0){const E=C(e.data.length-c,e.data.length);v=`/${V(s,!1,!1,!0)[E]}`}let x="Indefinito";o.has("3maj")?x="Maggiore":o.has("3min")?x="Minore":o.has("3dim")||o.has("2")?x="Sus 2":(o.has("3aug")||o.has("4"))&&(x="Sus 4");let p="Omessa";o.has("5")?p="Giusta":o.has("5aug")?p="Aumentata":o.has("5dim")&&(p="Diminuita");let b="Triade";o.has("7maj")?b="Mag 7":o.has("7min")?b="Min 7":(o.has("7dim")||o.has("6"))&&(b="Sesta/Dim");const k=[];o.has("2min")&&k.push("b9"),o.has("2")&&!x.includes("Sus")&&k.push("9"),o.has("2aug")&&k.push("#9"),o.has("4")&&!x.includes("Sus")&&k.push("11"),o.has("4aug")&&k.push("#11"),o.has("6min")&&k.push("b13"),o.has("6")&&!b.includes("Sesta")&&k.push("13");const W={thirdQuality:x,fifthQuality:p,seventhQuality:b,extensions:k};a.push([L,m,h,v,Array.from(o),W])}const i=c=>{let s=0;const o=c[2],m=c[3];return s+=o.length,m!==""&&(s+=2),(o.includes("add9")||o.includes("b9")||o.includes("#9"))&&(s+=3),c[1].includes("+")&&(s+=3),o.includes("omit3")&&(s+=3),o.includes("omit5")&&(s+=2),(o.includes("b9")||o.includes("#9")||o.includes("#11")||o.includes("b13"))&&(s+=2),(o.includes("add11")||o.includes("add13"))&&(s+=2),o.includes("sus")&&(s+=2),s};a.sort((c,s)=>{const o=i(c),m=i(s);return o-m});let r=0;r=0;const d=a[r];return{root:d[0],base:d[1],quality:d[2],inversion:d[3],intervals:d[4],detailedAnalysis:d[5],options:a}}function ue(l,t=!1){const e=Ce(l,t),a=V(e.root,!1,!1)[0],n=`${a}${e.base}${Array.isArray(e.quality)&&e.quality.length>0?e.quality.join(""):""}${e.inversion}`,i=e.options.map(r=>{const d=V(r[0],!1,!1)[0],c=r[1],s=Array.isArray(r[2])?r[2]:[],o=s.length>0?s.join(""):"",m=r[3]||"";return{chordName:`${d}${c}${o}${m}`,root:r[0].normalizeToModulo(),components:{rootName:d,base:c,quality:s,inversion:m,intervals:r[4],detailedAnalysis:r[5]},intervals:r[4],detailedAnalysis:r[5]}});return{chordName:n,root:e.root.normalizeToModulo(),rootName:a,base:e.base,quality:e.quality,inversion:e.inversion,intervals:e.intervals,detailedAnalysis:e.detailedAnalysis,options:i}}function V(l,t=!0,e=!1,a=!0,n=!1){const d=t?["Do","Re","Mi","Fa","Sol","La","Si"]:["C","D","E","F","G","A","B"],c=new I([0,2,4,5,7,9,11],12,12),s=new Q([2,2,1,2,2,2,1],12,0);let o=ye(c,l),m=o[0],h=o[1],v=Math.floor(h.data[0]/h.modulo)*h.modulo;const L=h.sum(-v);let x=0,p=L,b=0;if(n&&(b=ce(ue(p,!0).root,p).data[0],p=p.rototranslate(b)),m.element(x)<p.data[0])for(;m.element(x)<p.data[0];)x++;else for(;m.element(x)>=p.data[0];)x--;let k=p.getDegrees(),W=k,E=k,U=[],G=[],D=0,j=0;for(let f=0;f<p.data.length;f++){const z=Math.floor((p.data[f]-p.data[0])/p.modulo)*7;U[f]=p.data[f]-m.element(W[f]+x+z),D+=U[f],G[f]=p.data[f]-m.element(E[f]+x+z+1),j+=G[f]}let A=Math.abs(D)<=Math.abs(j)?U:G,S=Math.abs(D)<=Math.abs(j)?W:E;if(Math.abs(D)>Math.abs(j)&&x++,a)for(let f=0;f<A.length;f++){const z=s.element(S[f]+x),P=s.element(S[f]+x-1);Math.abs(A[f])>=z&&Math.sign(A[f])==1?(A[f]-=s.element(S[f]+x),S[f]+=1):Math.abs(A[f])>=P&&Math.sign(A[f])==-1&&(A[f]+=s.element(S[f]+x-1),S[f]-=1)}let F=[];for(let f=0;f<S.length;f++){const z=C(f-b,A.length),P=A[z],u=d[C(S[z]+x,7)];if(e){const g=Math.round(P*50);g!==0?F[f]=`${u} ${g>0?"â†‘":"â†“"}${Math.abs(g)}Â¢`:F[f]=u}else{const g=Math.round(P);if(Math.abs(P)<1&&P!==0)F[f]=u+(P>0?"ð„²":"ð„³");else if(g!==0){const w=g>0?"â™¯":"â™­";F[f]=u+w.repeat(Math.min(Math.abs(g),2))}else F[f]=u}}return F}const y=new Set;let H="sine";const te=["sine","triangle","square","sawtooth"],we={sine:'<path d="M2 12s4-8 10-8 10 8 10 8"/>',triangle:'<path d="M2 19l10-14 10 14"/>',square:'<path d="M3 12h6v-8h6v16h6"/>',sawtooth:'<path d="M4 18L20 6v12"/>',custom:""},Ie=window.AudioContext||window.webkitAudioContext;let M,X,R;function ae(){M||(M=new Ie,X=M.createGain(),R=M.createDynamicsCompressor(),R.threshold.value=-12,R.knee.value=30,R.ratio.value=3,R.attack.value=.003,R.release.value=.25,R.connect(X),X.connect(M.destination),X.gain.value=1.5),M.state==="suspended"&&M.resume()}function Z(){M||ae(),M.state==="suspended"&&M.resume().then(()=>{console.log("AudioContext resumed via unlock")});const l=M.createBuffer(1,1,22050),t=M.createBufferSource();t.buffer=l,t.connect(R),t.start(0),document.removeEventListener("touchstart",Z),document.removeEventListener("click",Z)}document.addEventListener("touchstart",Z,{once:!0});document.addEventListener("click",Z,{once:!0});function Ee(l){const[t,e,a]=l.data,n=t>>4;n===8||n===9&&a===0?Me(e):n===9&&Ne(e,a)}function Ne(l,t){const e=l-60;if(!y.has(e)){y.add(e);const a=t/127*.8;oe(se(e),.4,H,a),_()}}function Me(l){const t=l-60;y.has(t)&&(y.delete(t),_())}function Ae(){navigator.requestMIDIAccess?navigator.requestMIDIAccess().then(Le,ke):console.warn("WebMIDI is not supported in this browser.")}function Le(l){console.log("MIDI ready!");const t=l.inputs.values();for(let e of t)e.onmidimessage=Ee;l.onstatechange=e=>{console.log(e.port.name,e.port.state,e.port.type)}}function ke(l){console.error(`Failed to get MIDI access - ${l}`)}function se(l){const t=60+l;return 440*Math.pow(2,(t-69)/12)}function oe(l,t=.5,e="sine",a=1,n){ae();const i=n||M.currentTime,r=M.createOscillator(),d=M.createGain();r.type=e,r.frequency.setValueAtTime(l,i),d.gain.setValueAtTime(0,i),d.gain.linearRampToValueAtTime(a,i+.05),d.gain.exponentialRampToValueAtTime(.001,i+t),r.connect(d),d.connect(R),r.start(i),r.stop(i+t)}function Oe(){if(y.size===0)return;ae();const l=.4/Math.max(1,y.size);Array.from(y).sort((e,a)=>e-a).forEach((e,a)=>{const n=se(e),i=M.currentTime+a*.015;oe(n,1.5,H,l,i)})}function ie(){const l=document.getElementById("btn-waveform");if(!l)return;const t=`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${we[H]}</svg>`;l.innerHTML=t}const le=document.getElementById("btn-waveform");le&&(ie(),le.addEventListener("click",()=>{const t=(te.indexOf(H)+1)%te.length;H=te[t],ie()}));const T=new Map;function J(l,t){return(l%t+t)%t}const B=new Map;let O=[],N=0;function _(){if(console.log("analyzeChord: Start"),["node-root","node-char","node-stab","node-func","node-ext"].forEach(t=>{const e=document.getElementById(t);e&&e.classList.remove("active")}),document.getElementById("chordNameDisplay").textContent="--",document.getElementById("chordOptionsContainer").innerHTML="",document.getElementById("chordDetail").textContent="",document.getElementById("intervalList").textContent="--",["text-root","text-char","text-stab","text-func"].forEach(t=>document.getElementById(t).textContent="--"),document.getElementById("container-extensions").textContent="--",document.getElementById("container-omits").textContent="--",T.clear(),B.clear(),y.size===0){Y();return}const l=Array.from(y).sort((t,e)=>t-e);try{const t=new I(l,12,12).normalizeToModulo();console.log("analyzeChord: Calling scaleNames with isChord=true",{chordVecData:t.data});let e=[];try{e=V(t,!0,!1,!0,!0)}catch(c){throw console.error("analyzeChord: Error in scaleNames",c),c}l.forEach((c,s)=>{e[s]&&B.set(c,e[s])}),console.log("analyzeChord: Calling getChordName");let a;try{a=ue(t,!0)}catch(c){throw console.error("analyzeChord: Error in getChordName",c),c}const{chordName:n,root:i,options:r}=a;console.log("getChordName returned:",{chordName:n,root:i,optionsLength:r.length,options:r}),O=r,N=0;const d=r.findIndex(c=>c.chordName===n);d!==-1&&(N=d),console.log("selectedOptionIndex:",N,"currentOptions[selectedOptionIndex]:",O[N]),he(),O.length>0&&O[N]?fe():(console.warn("No valid chord analysis available, using fallback coloring"),l.forEach(c=>{T.set(c,"active")}))}catch(t){console.error("analyzeChord: CRITICAL ERROR encountered",t),console.error("Active Notes at crash:",Array.from(y)),Array.from(y).sort((a,n)=>a-n).forEach(a=>{T.set(a,"active")})}finally{Y()}}function he(){const l=document.getElementById("chordOptionsContainer");l&&(l.innerHTML="",O.forEach((t,e)=>{const a=document.createElement("button");a.textContent=t.chordName,a.onclick=()=>{console.log("Chord option clicked:",e,"currentOptions:",O),N=e,he(),console.log("About to call updateAnalysisDisplay with selectedOptionIndex:",N),fe(),console.log("Finished updateAnalysisDisplay, about to renderPiano"),Y()};const n=["px-3","py-1","rounded-full","text-xs","font-medium","transition","border"];e===N?a.classList.add(...n,"bg-blue-600","text-white","border-blue-500","shadow-md"):a.classList.add(...n,"bg-gray-800","text-gray-400","border-gray-700","hover:bg-gray-700","hover:text-gray-200"),l.appendChild(a)}))}function fe(){if(console.log("updateAnalysisDisplay: Start",{activeNotesSize:y.size,selectedOptionIndex:N,hasOption:!!O[N]}),y.size===0||!O[N]){console.log("updateAnalysisDisplay: Early exit - activeNotes.size:",y.size,"currentOptions[selectedOptionIndex]:",O[N]);return}const{chordName:l,root:t}=O[N],e=Array.from(y).sort((u,g)=>u-g),a=new I(e,12,12).normalizeToModulo(),n=ce(t,a).data[0],i=a.rototranslate(n,a.data.length,!1),r=V(i,!0,!1,!0,!1);B.clear();for(let u=0;u<r.length;u++){const g=J(i.data[u],12);e.forEach(w=>{J(w,12)===g&&r[u]&&B.set(w,r[u])})}const d=document.getElementById("chordNameDisplay"),{components:c}=O[N],s=c.rootName;c.quality.join(""),d.innerHTML="";const o=document.createElement("span"),m=s.indexOf("â™¯"),h=s.indexOf("â™­");if(m!==-1||h!==-1){const u=m!==-1?m:h,g=s.substring(0,u),w=s.substring(u),$=document.createTextNode(g);o.appendChild($);const q=document.createElement("span");q.textContent=w,q.className="inline-block transform -translate-y-3 text-5xl",o.appendChild(q)}else o.textContent=s;d.appendChild(o);let v=c.base,L=[...c.quality];const x=L.indexOf("â™­5");x!==-1&&(L.splice(x,1),v+="â™­5");const p=c.inversion;v=v.replace("dim","Â°");const b=document.createElement("span");if(v.includes("Â°")){const u=v.split("Â°");u[0]&&b.appendChild(document.createTextNode(u[0]));const g=document.createElement("span");g.textContent="Â°",g.className="text-5xl align-top -mt-1 inline-block",b.appendChild(g),u[1]&&b.appendChild(document.createTextNode(u[1]))}else b.textContent=v;if(d.appendChild(b),L.length>0)if(L.length>1){const u=document.createElement("span");u.className="inline-flex items-center align-top mx-1 -mt-2";const g=document.createElement("span");g.textContent="(",g.className="text-4xl text-gray-400 font-light mr-1 transform scale-y-150 origin-center";const w=document.createElement("div");w.className="flex flex-col justify-center leading-none text-center",L.forEach(q=>{const K=document.createElement("span");K.textContent=q,K.className="text-xl text-gray-300 font-medium tracking-tight my-0.5",w.appendChild(K)});const $=document.createElement("span");$.textContent=")",$.className="text-4xl text-gray-400 font-light ml-1 transform scale-y-150 origin-center",u.appendChild(g),u.appendChild(w),u.appendChild($),d.appendChild(u)}else{const u=document.createElement("span");u.className="text-4xl align-top -mt-2 inline-block text-gray-300 font-medium tracking-normal ml-1",u.textContent=L[0],d.appendChild(u)}if(p){const u=document.createElement("span");u.className="ml-1";const g=p.indexOf("â™¯"),w=p.indexOf("â™­");if(g!==-1||w!==-1){const $=g!==-1?g:w,q=p.substring(0,$),K=p.substring($),me=document.createTextNode(q);u.appendChild(me);const ee=document.createElement("span");ee.textContent=K,ee.className="inline-block transform -translate-y-3 text-5xl",u.appendChild(ee)}else u.textContent=p;d.appendChild(u)}O[N].intervals;const k=t.data[0],W=k;T.clear(),console.log("Cleared noteIntervals, about to initialize with 'ext'"),e.forEach(u=>{T.set(u,"ext")});const E=(u,g)=>{e.forEach(w=>{const $=J(w,12),q=J($-W,12);u.includes(q)&&(console.log(`Assigning color ${g} to noteId ${w} (interval ${q})`),T.set(w,g))})};["node-root","node-char","node-stab","node-func"].forEach(u=>{document.getElementById(u).classList.remove("active")}),document.getElementById("node-root").classList.add("active");const U=B.get(k);document.getElementById("text-root").textContent=U,E([0],"root");const G=document.getElementById("node-char"),{thirdQuality:D,fifthQuality:j,seventhQuality:A,extensions:S}=O[N].detailedAnalysis;G.classList.add("active"),document.getElementById("text-char").textContent=D,D==="Maggiore"?E([4],"third"):D==="Minore"?E([3],"third"):D==="Sus 2"?E([2],"third"):D==="Sus 4"?E([5],"third"):G.classList.remove("active");const F=document.getElementById("node-stab");F.classList.add("active"),document.getElementById("text-stab").textContent=j,j==="Giusta"?E([7],"fifth"):j==="Aumentata"?E([8],"fifth"):j==="Diminuita"?E([6],"fifth"):j==="Omessa"&&F.classList.remove("active");const f=document.getElementById("node-func");f.classList.add("active"),document.getElementById("text-func").textContent=A,A==="Mag 7"?E([11],"seventh"):A==="Min 7"?E([10],"seventh"):A==="Sesta/Dim"?E([9],"seventh"):A==="Triade"&&f.classList.remove("active");const z=document.getElementById("container-extensions"),P=document.getElementById("node-ext");S.length>0?(z.textContent=S.join(", "),P.classList.add("active")):(z.textContent="Nessuna",P.classList.remove("active")),console.log("updateAnalysisDisplay complete. Final noteIntervals:",Array.from(T.entries()))}function ne(l,t){const e=a=>{a.type==="touchstart"&&a.preventDefault(),Z(),a.stopPropagation(),Se(t)};l.addEventListener("mousedown",e),l.addEventListener("touchstart",e,{passive:!1})}function Y(){const l=document.getElementById("keyboard");if(!l)return;l.innerHTML="";const t=[{noteIndex:0,label:"Do",hasBlackLeft:!1},{noteIndex:2,label:"Re",hasBlackLeft:!0},{noteIndex:4,label:"Mi",hasBlackLeft:!0},{noteIndex:5,label:"Fa",hasBlackLeft:!1},{noteIndex:7,label:"Sol",hasBlackLeft:!0},{noteIndex:9,label:"La",hasBlackLeft:!0},{noteIndex:11,label:"Si",hasBlackLeft:!0}],e=2;for(let d=0;d<e;d++)t.forEach(c=>{const s=c.noteIndex+d*12;let o="";if(y.has(s)){const v=T.get(s);v?o=`key-${v}`:o="active"}let m="";y.has(s)&&B.has(s)?m=B.get(s):c.noteIndex===0&&(m=`C${d+4}`);const h=document.createElement("div");if(h.className=`white-key relative flex-1 h-full border border-gray-800 rounded-b cursor-pointer flex items-end justify-center pb-2 text-sm text-gray-500 select-none ${o}`,h.style.zIndex="1",y.has(s)&&(h.style.color="white",h.style.fontWeight="bold"),h.textContent=m,ne(h,s),c.hasBlackLeft){const v=s-1;let L="";if(y.has(v)){const b=T.get(v);b?L=`key-${b}`:L="active"}let x="";y.has(v)&&B.has(v)&&(x=B.get(v));const p=document.createElement("div");p.className=`black-key absolute top-0 h-2/3 w-[60%] rounded-b border border-black cursor-pointer flex items-end justify-center pb-2 text-[10px] select-none ${L}`,p.style.left="0",p.style.transform="translateX(-50%)",p.style.zIndex="10",y.has(v)?(p.style.color="white",p.style.fontWeight="bold"):p.style.color="transparent",p.textContent=x,ne(p,v),h.appendChild(p)}l.appendChild(h)});const a=24;let n="";if(y.has(a)){const d=T.get(a);d?n=`key-${d}`:n="active"}let i="C6";y.has(a)&&B.has(a)&&(i=B.get(a));const r=document.createElement("div");r.className=`white-key relative flex-1 h-full border border-gray-800 rounded-b cursor-pointer flex items-end justify-center pb-2 text-sm text-gray-500 select-none ${n}`,r.style.zIndex="1",y.has(a)&&(r.style.color="white",r.style.fontWeight="bold"),r.textContent=i,ne(r,a),l.appendChild(r)}function Se(l){y.has(l)?y.delete(l):(y.add(l),oe(se(l),.4,H,.8)),_()}function Be(){y.clear(),T.clear(),_()}window.playCurrentChord=Oe;window.resetPiano=Be;function re(){try{Y(),Ae()}catch(l){console.error("Error during initial renderPiano:",l)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",re):re();</script>
  <style rel="stylesheet" crossorigin>@import"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap";body{font-family:Inter,sans-serif;background-color:#0a0a0a;color:#e0e0e0}.white-key{background:linear-gradient(to bottom,#fff,#e6e6e6);position:relative;z-index:1}.white-key.active{background:#3b82f6!important;box-shadow:inset 0 -3px #0003}.black-key{background:linear-gradient(to bottom,#333,#000);box-shadow:2px 2px 5px #0009;z-index:10}.black-key.active{background:#60a5fa!important;border:1px solid #3b82f6}.flow-node{background:#161616;border:1px solid #262626;transition:all .2s ease}.flow-node.active{border-color:#3b82f6;background:#1e3a8a26;box-shadow:0 4px 20px #0000004d}.ext-tag{background:#1e3a8a;border:1px solid #1d4ed8;color:#bfdbfe;font-size:.8rem;padding:4px 10px;border-radius:6px;font-weight:600}.omit-tag{background:#451a1a;border:1px solid #7f1d1d;color:#fecaca;font-size:.8rem;padding:4px 10px;border-radius:6px;font-weight:600}.btn-action{transition:all .2s}.btn-action:active{transform:scale(.95)}.card-node{background:#121212;border:1px solid #333;border-radius:16px;padding:12px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;transition:all .3s ease;min-height:90px;position:relative}@media(min-width:768px){.card-node{flex-direction:row;justify-content:space-between;text-align:left;min-height:70px}}:root{--col-root: #81c784;--col-third: #64b5f6;--col-fifth: #e57373;--col-seventh: #ffd54f;--col-ext: #ba68c8}.theme-root.active{border-color:var(--col-root);box-shadow:0 0 15px #81c78433}.theme-root .label{color:var(--col-root)}.theme-root .value{color:#fff}.theme-third.active{border-color:var(--col-third);box-shadow:0 0 15px #64b5f633}.theme-third .label{color:var(--col-third)}.theme-third .value{color:#fff}.theme-fifth.active{border-color:var(--col-fifth);box-shadow:0 0 15px #e5737333}.theme-fifth .label{color:var(--col-fifth)}.theme-fifth .value{color:#fff}.theme-seventh.active{border-color:var(--col-seventh);box-shadow:0 0 15px #ffd54f33}.theme-seventh .label{color:var(--col-seventh)}.theme-seventh .value{color:#fff}.theme-ext.active{border-color:var(--col-ext);box-shadow:0 0 15px #ba68c833}.theme-ext .label{color:var(--col-ext)}.theme-ext .value{color:#fff}.key-root{background:var(--col-root)!important;box-shadow:0 0 15px var(--col-root)!important;border:none!important}.key-third{background:var(--col-third)!important;box-shadow:0 0 15px var(--col-third)!important;border:none!important}.key-fifth{background:var(--col-fifth)!important;box-shadow:0 0 15px var(--col-fifth)!important;border:none!important}.key-seventh{background:var(--col-seventh)!important;box-shadow:0 0 15px var(--col-seventh)!important;border:none!important}.key-ext{background:var(--col-ext)!important;box-shadow:0 0 15px var(--col-ext)!important;border:none!important}.hide-scroll::-webkit-scrollbar{display:none}</style>
</head>

<body class="min-h-screen flex flex-col items-center p-2 md:p-4 bg-[#0a0a0a] text-[#e0e0e0]">

    <!-- Main Container -->
    <main class="w-full max-w-7xl p-2 md:p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-3 md:gap-6 lg:gap-8">

        <!-- Left Column: Analysis (5 cols) -->
        <div class="lg:col-span-5 flex flex-col gap-3 md:gap-6">
            <!-- Header -->
            <div class="flex justify-between items-center px-2">
                <div class="flex items-center gap-4">
                    <div class="text-gray-500 text-sm font-medium tracking-widest uppercase">Analizzatore Armonico</div>
                </div>
                <div class="text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- Chord Display - Made larger -->
            <div class="text-center lg:text-left py-2 md:py-4">
                <h2 id="chordNameDisplay"
                    class="text-5xl md:text-6xl lg:text-7xl font-bold text-white tracking-tight drop-shadow-2xl mb-2">--
                </h2>
                <div id="chordOptionsContainer"
                    class="flex flex-wrap justify-center lg:justify-start gap-2 mb-4 min-h-[2rem]"></div>
                <div id="chordDetail" class="text-xl text-gray-500 font-light"></div>
                <div id="intervalList" class="hidden">--</div>
            </div>

            <!-- Analysis Grid -->
            <div class="grid grid-cols-2 gap-3">

                <!-- 1. Root (Green) -->
                <div id="node-root" class="card-node theme-root">
                    <div class="flex md:flex-row flex-col items-center gap-2 md:gap-3">
                        <div class="text-2xl opacity-80">â… </div>
                        <div class="label text-[10px] font-bold uppercase tracking-widest">1. Fondamentale</div>
                    </div>
                    <div class="value text-2xl font-bold" id="text-root">--</div>
                </div>

                <!-- 2. Quality (Blue) -->
                <div id="node-char" class="card-node theme-third">
                    <div class="flex md:flex-row flex-col items-center gap-2 md:gap-3">
                        <div class="text-2xl opacity-80">â…¢</div>
                        <div class="label text-[10px] font-bold uppercase tracking-widest">2. QualitÃ </div>
                    </div>
                    <div class="value text-xl font-bold leading-tight" id="text-char">--</div>
                </div>

                <!-- 3. Stability (Reddish) -->
                <div id="node-stab" class="card-node theme-fifth">
                    <div class="flex md:flex-row flex-col items-center gap-2 md:gap-3">
                        <div class="text-2xl opacity-80">â…¤</div>
                        <div class="label text-[10px] font-bold uppercase tracking-widest">3. StabilitÃ </div>
                    </div>
                    <div class="value text-xl font-bold leading-tight" id="text-stab">--</div>
                </div>

                <!-- 4. Function (Yellow) -->
                <div id="node-func" class="card-node theme-seventh">
                    <div class="flex md:flex-row flex-col items-center gap-2 md:gap-3">
                        <div class="text-2xl opacity-80">â…¦</div>
                        <div class="label text-[10px] font-bold uppercase tracking-widest">4. Funzione</div>
                    </div>
                    <div class="value text-xl font-bold leading-tight" id="text-func">--</div>
                </div>
            </div>

            <!-- Extensions (Purple) - Fixed centering -->
            <div id="node-ext" class="card-node theme-ext">
                <div class="w-full">
                    <div class="label text-[10px] font-bold uppercase tracking-widest mb-1 text-center md:text-left">
                        Estensioni</div>
                    <div id="container-extensions" class="value text-2xl font-bold text-center md:text-left">--</div>
                </div>
            </div>

            <!-- Hidden container for omissions (to prevent JS errors) -->
            <div id="container-omits" class="hidden">--</div>

        </div>

        <!-- Right Column: Keyboard & Controls (7 cols) -->
        <div
            class="lg:col-span-7 flex flex-col justify-center items-center min-h-[200px] lg:min-h-[500px] bg-[#111] rounded-3xl border border-[#222] p-2 lg:p-8 relative overflow-hidden">

            <!-- Background Decoration -->
            <div class="absolute inset-0 bg-gradient-to-br from-blue-900/10 to-purple-900/10 pointer-events-none"></div>

            <!-- Controls Header -->
            <div class="flex justify-between items-center w-full max-w-[600px] mb-2 lg:mb-4 relative z-10">
                <div class="text-xs text-gray-500 font-bold uppercase tracking-widest">
                    Tastiera Interattiva
                </div>
                <div class="flex gap-2 lg:gap-3">
                    <!-- Waveform Toggle -->
                    <button id="btn-waveform"
                        class="h-10 w-10 rounded-full bg-[#161616] text-gray-400 hover:text-white border border-[#333] hover:border-gray-500 flex items-center justify-center transition-colors focus:outline-none shadow-sm"
                        title="Cambia Forma d'Onda">
                        <!-- Icon injected by JS -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12h5l3 5 4-10 3 5h5" />
                        </svg>
                    </button>

                    <!-- Play Button -->
                    <button onclick="playCurrentChord()"
                        class="h-10 w-10 rounded-full bg-[#222] text-white hover:bg-[#333] border border-[#333] flex items-center justify-center shadow-sm transition active:scale-95"
                        title="Suona Accordo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>

                    <!-- Reset Button -->
                    <button onclick="resetPiano()"
                        class="h-10 w-10 rounded-full bg-[#222] text-gray-400 hover:bg-[#333] border border-[#333] flex items-center justify-center shadow-sm transition active:scale-95"
                        title="Resetta">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v3.276a1 1 0 01-2 0V14.907a7.002 7.002 0 01-11.669-3.676 1 1 0 01.676-1.174z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Piano Container -->
            <div
                class="overflow-x-auto hide-scroll pb-1 lg:pb-4 w-full flex justify-start lg:justify-center relative z-10">
                <div class="w-full flex justify-center">
                    <div id="keyboard" class="flex relative select-none h-32 lg:h-48 w-full max-w-[600px]"
                        style="touch-action: none;">
                        <!-- Keys generated via JS -->
                    </div>
                </div>
            </div>

        </div>

    </main>

</body>

</html>